// Claude API call function with memory integration
async function callClaude(messages) {
    try {
        // Add memory context to the system prompt
        const memoryContext = generateMemoryContext();
        let systemMessage = SYSTEM_PROMPT;
        
        // Add memory context to system message if available
        if (memoryContext) {
            systemMessage += memoryContext;
        }
        
        // Convert messages for the serverless function (skip system message)
        const messagesToSend = [];
        for (let i = 1; i < messages.length; i++) {
            const msg = messages[i];
            messagesToSend.push({
                role: msg.role === 'assistant' ? 'assistant' : 'user',
                content: msg.content
            });
        }

        // Call your Netlify function
        const response = await fetch('/.netlify/functions/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                messages: messagesToSend,
                systemMessage: systemMessage
            })
        });
        
        if (!response.ok) {
            throw new Error(`Function Error: ${response.status}`);
        }
        
        const data = await response.json();
        const apiResponse = data.choices[0].message.content.trim();
        
        // Check if API gave generic unhelpful response and fall back to local responses
        if (apiResponse.includes("I'm really sorry that you're feeling this way, but I'm unable to provide the help that you need") ||
            apiResponse.includes("It's really important to talk things over with someone who can") ||
            apiResponse.includes("mental health professional or a trusted person in your life") ||
            apiResponse.includes("I'm not able to provide") ||
            apiResponse.includes("I can't provide the support you need")) {
            
            const lastUserMessage = messages[messages.length - 1].content;
            return generateIntelligentResponse(lastUserMessage, messages);
        }
        
        return data;
        
    } catch (error) {
        console.error('Netlify Function Error:', error);
        const lastUserMessage = messages[messages.length - 1].content;
        return generateIntelligentResponse(lastUserMessage, messages);
    }
}
