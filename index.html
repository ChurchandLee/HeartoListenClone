<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HeartoListen - AI Mental Wellbeing Support</title>
<meta name="description" content="Free AI-powered Mental Wellbeing Support Companion. Your 24/7 safe, private and judgement-free space for mental wellness.">
<meta name="theme-color" content="#8eaf78">

<!-- PWA and App Icon Meta Tags -->
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="manifest" href="app-manifest.json">

<!-- iOS specific -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="HeartoListen">

<!-- Android specific -->
<meta name="mobile-web-app-capable" content="yes">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #8eaf78 0%, #764ba2 100%);
min-height: 100vh;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
background-image: url('https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/fern background.png');
}

.container {
width: 100%;
max-width: 800px;
background: rgba(255, 255, 255, 0.95);
border-radius: 20px;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(10px);
overflow: hidden;
display: flex;
flex-direction: column;
height: 700px;
}

.logo-header {
background: linear-gradient(135deg, #5f795a 0%, #4CAF50 100%);
padding: 25px;
text-align: center;
color: white;
border-bottom: 3px solid rgba(255, 255, 255, 0.2);
transition: all 0.3s ease;
}

/* Compact header state */
.logo-header.compact {
padding: 15px;
}

.logo {
width: 150px;
height: 150px;
margin: 0 auto 15px auto;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
position: relative;
}

/* Compact logo state */
.logo-header.compact .logo {
width: 60px;
height: 60px;
margin: 0 auto;
}

.logo:hover {
transform: scale(1.05);
}

.logo-header h1 {
font-size: 2.2em;
margin-bottom: 8px;
font-weight: 700;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.logo-header p {
opacity: 0.95;
font-size: 1.1em;
font-weight: 500;
transition: all 0.3s ease;
}

/* Hide text in compact mode */
.logo-header.compact h1,
.logo-header.compact p {
display: none;
}

.chat-area {
flex: 1;
overflow-y: auto;
padding: 20px;
display: flex;
flex-direction: column;
gap: 15px;
background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
}

.message {
max-width: 85%;
padding: 15px 20px;
border-radius: 18px;
animation: fadeIn 0.3s ease-out;
line-height: 1.6;
font-size: 15px;
white-space: pre-wrap;
}

.ai-message {
background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
color: #274e13;
align-self: flex-start;
border-left: 4px solid #4CAF50;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
display: flex;
align-items: flex-start;
gap: 12px;
padding: 15px 20px;
}

.ai-message-content {
flex: 1;
line-height: 1.6;
}

.ai-avatar {
width: 50px;
height: 50px;
border-radius: 50%;
border: 2px solid rgba(76, 175, 80, 0.3);
object-fit: cover;
object-position: center;
flex-shrink: 0;
}

.user-message {
background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
color: white;
align-self: flex-end;
box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
}

.error-message {
background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
color: #c62828;
align-self: flex-start;
border-left: 4px solid #f44336;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.thinking-heart {
font-size: 24px;
animation: heartPulse 1.5s ease-in-out infinite;
display: flex;
justify-content: center;
align-items: center;
}

.welcome-section {
text-align: center;
margin: 20px 0;
padding: 25px;
background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(139, 195, 74, 0.08) 100%);
border-radius: 15px;
border: 2px dashed rgba(76, 175, 80, 0.2);
}

.welcome-section h2 {
color: #8eaf78;
font-size: 1.4em;
margin-bottom: 10px;
font-weight: 600;
}

.welcome-section p {
color: #5a6c57;
line-height: 1.6;
margin-bottom: 15px;
}

/* Memory recap section */
.memory-recap {
background: linear-gradient(135deg, rgba(142, 175, 120, 0.08) 0%, rgba(255, 223, 186, 0.08) 100%);
border: 2px dashed rgba(142, 175, 120, 0.3);
border-radius: 12px;
padding: 15px;
margin: 15px 0;
font-size: 13px;
color: #5a6c57;
text-align: left;
}

.memory-recap h4 {
color: #8eaf78;
margin-bottom: 10px;
font-size: 14px;
display: flex;
align-items: center;
gap: 8px;
}

.memory-recap ul {
padding-left: 20px;
margin: 0;
}

.memory-recap li {
margin-bottom: 5px;
line-height: 1.4;
}

.disclaimer {
background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
border: 2px solid #f39c12;
border-radius: 12px;
padding: 15px;
margin: 15px 0;
font-size: 13px;
color: #8b4513;
text-align: center;
font-weight: 500;
}

.input-area {
padding: 20px;
background: rgba(255, 255, 255, 0.95);
border-top: 1px solid rgba(0, 0, 0, 0.1);
display: flex;
gap: 15px;
align-items: center;
}

.input-field {
flex: 1;
padding: 15px 20px;
border: 2px solid #e0e0e0;
border-radius: 25px;
font-size: 14px;
outline: none;
transition: all 0.3s ease;
background: white;
font-family: inherit;
}

.input-field:focus {
border-color: #4CAF50;
box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.send-button {
padding: 15px 25px;
background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
color: white;
border: none;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 80px;
}

.send-button:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
}

.send-button:active {
transform: translateY(0);
}

.send-button:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

@keyframes heartPulse {
0%, 100% {
transform: scale(1);
opacity: 0.8;
}
50% {
transform: scale(1.3);
opacity: 1;
}
}

/* Responsive design */
@media (max-width: 600px) {
.container {
height: 90vh;
margin: 10px;
}

.logo {
width: 120px;
height: 120px;
}

.logo-header.compact .logo {
width: 50px;
height: 50px;
}

.logo-header h1 {
font-size: 1.8em;
}

.message {
max-width: 95%;
}
}

/* DISCLAIMER MODAL STYLES */
.disclaimer-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
z-index: 3000;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
backdrop-filter: blur(5px);
}

.disclaimer-modal {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 600px;
width: 100%;
max-height: 80vh;
overflow-y: auto;
text-align: left;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
animation: disclaimerSlideIn 0.4s ease-out;
border: 3px solid #8eaf78;
}

.disclaimer-modal h2 {
color: #8eaf78;
text-align: center;
margin-bottom: 25px;
font-size: 1.8em;
font-weight: 700;
}

.disclaimer-modal .warning-icon {
text-align: center;
font-size: 3em;
margin-bottom: 15px;
}

.disclaimer-content {
color: #333;
line-height: 1.6;
font-size: 14px;
}

.disclaimer-content p {
margin-bottom: 15px;
}

.disclaimer-content strong {
color: #2c5530;
font-weight: 600;
}

.emergency-section {
background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
border: 2px solid #e91e63;
border-radius: 12px;
padding: 20px;
margin: 20px 0;
}

.emergency-section h3 {
color: #c2185b;
margin-bottom: 15px;
font-size: 1.2em;
display: flex;
align-items: center;
gap: 10px;
}

.emergency-contacts {
margin: 15px 0;
padding-left: 20px;
}

.emergency-contacts li {
margin-bottom: 8px;
color: #880e4f;
font-weight: 500;
}

.important-notes {
background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
border: 2px solid #f39c12;
border-radius: 12px;
padding: 20px;
margin: 20px 0;
}

.important-notes h3 {
color: #e67e22;
margin-bottom: 15px;
font-size: 1.2em;
display: flex;
align-items: center;
gap: 10px;
}

.important-notes ul {
padding-left: 20px;
}

.important-notes li {
margin-bottom: 8px;
color: #8b4513;
}

.disclaimer-buttons {
display: flex;
gap: 15px;
justify-content: center;
margin-top: 30px;
flex-wrap: wrap;
}

.btn-accept {
background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 180px;
}

.btn-accept:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(142, 175, 120, 0.3);
}

.btn-help {
background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 180px;
}

.btn-help:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(233, 30, 99, 0.3);
}

@keyframes disclaimerSlideIn {
from {
opacity: 0;
transform: translateY(-50px) scale(0.9);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

/* Mobile responsiveness */
@media (max-width: 600px) {
.disclaimer-modal {
padding: 20px;
margin: 10px;
max-height: 90vh;
}

.disclaimer-modal h2 {
font-size: 1.5em;
}

.disclaimer-content {
font-size: 13px;
}

.disclaimer-buttons {
flex-direction: column;
align-items: center;
}

.btn-accept,
.btn-help {
width: 100%;
max-width: 250px;
}
}

.hidden {
display: none !important;
}
</style>
</head>
<body>
<!-- DISCLAIMER MODAL -->
<div id="disclaimerOverlay" class="disclaimer-overlay hidden">
<div class="disclaimer-modal">
<div class="warning-icon">⚠️</div>
<h2>Important Disclaimer</h2>

<div class="disclaimer-content">
<p><strong>This app is designed to provide emotional support, encouragement, and validation. It is not a substitute for professional medical, psychiatric, or psychological treatment.</strong></p>

<p>The content and features within this app are for general well-being, personal growth, and self-reflection purposes only. We are not medical professionals, and this app does not offer medical, clinical, or therapeutic advice.</p>

<p>If you are experiencing significant distress, a mental health crisis, or believe you may have a condition requiring diagnosis or treatment, please seek help from a qualified healthcare provider.</p>

<div class="important-notes">
<h3>📋 Important Notes</h3>
<ul>
<li>The app does not provide diagnosis, treatment, prescriptions, or medical interventions.</li>
<li>Use of this app is voluntary and should be considered a complementary tool to professional care, not a replacement.</li>
<li>Any decisions you make based on the information, tools, or suggestions provided are your personal responsibility.</li>
</ul>
</div>

<p><strong>By using this app, you acknowledge and agree that it is intended to provide support, validation, and helpful resources, but it cannot and does not replace the care of licensed professionals.</strong></p>
</div>

<div class="disclaimer-buttons">
<button class="btn-accept" onclick="acceptDisclaimer()">I Understand & Agree</button>
<button class="btn-help" onclick="getNeedHelpNow()">I Need Help Now</button>
</div>

<div class="emergency-section">
<h3>🚨 Emergency Situations</h3>
<p><strong>If you are in immediate danger or experiencing thoughts of harming yourself or others, please call your local emergency number right away.</strong></p>

<ul class="emergency-contacts">
<li><strong>In the U.S.:</strong> you can dial 988 for the Suicide & Crisis Lifeline</li>
<li><strong>In the U.K. & Ireland:</strong> you can call Samaritans at 116 123</li>
<li><strong>In Australia:</strong> you can call Lifeline at 13 11 14</li>
</ul>

<p>If you are outside these regions, please look up local emergency and crisis services in your area.</p>
</div>
</div>
</div>

<div class="container">
<!-- Logo Header Section -->
<div class="logo-header" id="logoHeader">
<div class="logo">
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png" alt="HeartoListen Logo" style="width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 10;">
</div> 
<h1>HeartoListen</h1>
<p>AI Mental Wellbeing Support - Self Discovery for Positive Mental Health</p>
</div>

<!-- Chat Area -->
<div class="chat-area" id="chatArea">
<!-- Welcome Message -->
<div class="welcome-section" id="welcomeSection">
<h2>Welcome to Hear to Listen</h2>
<div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(76, 175, 80, 0.3); object-fit: cover; object-position: center;">
<p style="margin: 0;">I'm Eden and I am here to listen and support you through whatever you're experiencing. This is a safe, judgement-free space where you can share your thoughts and feelings.</p>
</div>

<!-- Memory Recap Section (hidden initially) -->
<div class="memory-recap" id="memoryRecap" style="display: none;">
<h4>Previous conversations:</h4>
<ul id="memoryList"></ul>
</div>

<!-- Important Disclaimer -->
<div class="disclaimer">
<strong>⚠️ Important Safety Information:</strong>
<br><br>
<strong>Crisis Support:</strong> If you're having thoughts of suicide or self-harm, please reach out immediately:
<br>• <strong>UK:</strong> 999 (Emergency) | 116 123 (Samaritans - 24/7 free)
<br>• <strong>USA:</strong> 911 (Emergency) | 988 (Suicide & Crisis Lifeline)
<br>• <strong>Crisis Text:</strong> Text HOME to 741741
<br><br>
<strong>This app provides peer support and guidance, not professional medical advice.</strong> For ongoing mental health concerns, please seek professional Mental Wellbeing Support
</div>
</div>
</div>

<!-- Input Area -->
<div class="input-area">
<input type="text" 
id="messageInput" 
class="input-field" 
placeholder="What's on your mind......" 
onkeypress="handleKeyPress(event)">
<button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
</div>
</div>

<script>
// MEMORY SYSTEM (using in-memory storage for this environment)
let sessionMemories = [];
const MAX_MEMORIES = 10;
const MEMORY_EXPIRY_DAYS = 30;

// Memory management functions adapted for in-memory storage
function saveMemory(userMessage, aiResponse, emotion = null) {
const newMemory = {
id: Date.now(),
date: new Date().toISOString(),
userMessage: userMessage,
aiResponse: aiResponse,
emotion: emotion,
timestamp: Date.now()
};

// Add new memory to beginning of array
sessionMemories.unshift(newMemory);

// Keep only the most recent memories
sessionMemories = sessionMemories.slice(0, MAX_MEMORIES);
}

function getMemories() {
return sessionMemories || [];
}

function extractEmotion(message) {
const lowerMessage = message.toLowerCase();
if (lowerMessage.includes('sad') || lowerMessage.includes('depressed') || lowerMessage.includes('down')) return 'sad';
if (lowerMessage.includes('anxious') || lowerMessage.includes('worried') || lowerMessage.includes('scared')) return 'anxious';
if (lowerMessage.includes('angry') || lowerMessage.includes('frustrated') || lowerMessage.includes('mad')) return 'angry';
if (lowerMessage.includes('lonely') || lowerMessage.includes('alone') || lowerMessage.includes('isolated')) return 'lonely';
if (lowerMessage.includes('stressed') || lowerMessage.includes('overwhelmed')) return 'stressed';
if (lowerMessage.includes('happy') || lowerMessage.includes('good') || lowerMessage.includes('better')) return 'positive';
// Mental health conditions
if (lowerMessage.includes('bpd') || lowerMessage.includes('borderline')) return 'bpd';
if (lowerMessage.includes('adhd') || lowerMessage.includes('add')) return 'adhd';
if (lowerMessage.includes('autism') || lowerMessage.includes('autistic')) return 'autism';
if (lowerMessage.includes('bipolar') || lowerMessage.includes('manic')) return 'bipolar';
if (lowerMessage.includes('ptsd') || lowerMessage.includes('trauma')) return 'ptsd';
return null;
}

function generateMemoryContext() {
const memories = getMemories();
if (memories.length === 0) return '';

// Create memory context for AI
let context = '\n\nRECENT CONVERSATION MEMORY:\n';
memories.slice(0, 5).forEach((memory, index) => {
const date = new Date(memory.date);
const relativeTime = getRelativeTime(date);
context += `${relativeTime}: User shared "${memory.userMessage.substring(0, 100)}..."\n`;
if (memory.emotion) {
context += `- User was feeling ${memory.emotion}\n`;
}
});

context += '\nPlease acknowledge and reference relevant previous conversations naturally in your response when appropriate.\n';
return context;
}

function getRelativeTime(date) {
const now = new Date();
const diffMs = now - date;
const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

if (diffHours < 1) return 'Earlier today';
if (diffHours < 24) return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
if (diffDays === 1) return 'Yesterday';
if (diffDays < 7) return `${diffDays} days ago`;
return 'Last week';
}

function displayMemoryRecap() {
// Memory recap disabled - memories still work in background for AI responses
return;
}

// DISCLAIMER MODAL FUNCTIONS
function showDisclaimerModal() {
// Using sessionStorage for disclaimer seen status (since it's temporary)
const hasSeenDisclaimer = sessionStorage.getItem('heartoListenDisclaimerSeen');
if (hasSeenDisclaimer !== 'true') {
document.getElementById('disclaimerOverlay').classList.remove('hidden');
document.body.style.overflow = 'hidden';
} else {
displayMemoryRecap();
}
}

function acceptDisclaimer() {
sessionStorage.setItem('heartoListenDisclaimerSeen', 'true');
document.getElementById('disclaimerOverlay').classList.add('hidden');
document.body.style.overflow = 'auto';

displayMemoryRecap();

setTimeout(() => {
document.getElementById('messageInput').focus();
}, 100);
}

function getNeedHelpNow() {
window.open('https://988lifeline.org/', '_blank');
window.open('https://www.samaritans.org/', '_blank');
window.open('https://www.lifeline.org.au/', '_blank');
}

// Claude API Configuration
const CLAUDE_API_KEY = 'YOUR_CLAUDE_API_KEY_HERE'; // Replace with your Anthropic API key

// Enhanced Mental Health System Prompt for Claude 4 Sonnet
const SYSTEM_PROMPT = `You are a compassionate AI mental health companion named "Eden" from HeartoListen. Your primary role is to provide supportive, exploratory conversations that help people process their feelings and thoughts. You have memory of previous conversations and should reference them naturally when relevant.

CORE IDENTITY:
- You are Eden, a warm and empathetic AI companion focused on mental wellbeing
- You provide emotional support through active listening and thoughtful exploration
- You remember previous conversations and show genuine ongoing care
- You create a safe, non-judgmental space for people to process their feelings

CONVERSATION APPROACH:
- Engage with genuine curiosity about their unique experience
- Ask thoughtful, open-ended questions that encourage deeper reflection
- Validate their emotions without immediately jumping to solutions
- Help them explore their own thoughts and feelings at their own pace
- Reference previous conversations naturally to show continuity of care
- Offer gentle insights and coping strategies when the moment feels right

MEMORY INTEGRATION:
- When you see "RECENT CONVERSATION MEMORY" in the context, use this thoughtfully
- Reference past conversations naturally: "I remember you mentioned feeling..."
- Follow up on previous concerns: "How have you been processing that situation we talked about?"
- Show you care by remembering details and checking in authentically
- Let memory enhance the conversation without forcing it

EMOTIONAL RESPONSIVENESS:
- When someone expresses sadness, anxiety, loneliness, or other difficult emotions, respond with empathy and curiosity
- Ask specific questions about their experience: "What does this loneliness look like in your daily life?"
- Explore the context: "What's been happening that's bringing up these feelings?"
- Validate their experience: "That sounds really difficult" or "I can hear the pain in what you're sharing"
- Show genuine interest in understanding their unique situation

CRISIS RECOGNITION:
- For explicit mentions of suicide, self-harm, or immediate danger, provide crisis resources
- US: 988 (Suicide & Crisis Lifeline), UK: 116 123 (Samaritans), Crisis Text: HOME to 741741
- Express genuine concern while connecting them to appropriate help

TONE GUIDELINES:
- Conversational and warm, like a caring friend who truly listens
- Vary your language significantly - avoid repetitive phrases
- Be present and engaged with their specific situation
- Balance empathy with gentle challenge when helpful
- Encourage self-reflection and personal insight
- Maintain hope and focus on their strengths

Remember: Your goal is meaningful, supportive conversation that helps people feel heard, understood, and gently guided toward their own insights and healing. You are not providing therapy, but rather compassionate peer support with the enhanced capability of remembering and caring about their ongoing journey.`;

// Chat functionality with Claude API integration
let conversationHistory = [{
role: 'system',
content: SYSTEM_PROMPT
}];

// Claude API call function with memory integration
async function callClaude(messages) {
try {
// Add memory context to the conversation
const memoryContext = generateMemoryContext();
const enhancedMessages = [...messages];

if (memoryContext && enhancedMessages.length > 1) {
// Add memory context to the last user message
const lastUserMessage = enhancedMessages[enhancedMessages.length - 1];
enhancedMessages[enhancedMessages.length - 1] = {
...lastUserMessage,
content: lastUserMessage.content + memoryContext
};
}

const response = await fetch('https://api.anthropic.com/v1/messages', {
method: 'POST',
headers: {
'x-api-key': CLAUDE_API_KEY,
'Content-Type': 'application/json',
'anthropic-version': '2023-06-01'
},
body: JSON.stringify({
model: "claude-3-5-sonnet-20241022", // Using Claude 3.5 Sonnet as Claude 4 may not be available yet
max_tokens: 800,
temperature: 0.7,
messages: enhancedMessages.slice(1) // Remove system message for Anthropic API format
})
});

if (!response.ok) {
throw new Error(`Claude API Error: ${response.status}`);
}

const data = await response.json();
const aiResponse = data.content[0].text.trim();

// Return in OpenAI-compatible format for consistency
return {
choices: [{
message: {
content: aiResponse
}
}]
};

} catch (error) {
console.error('Claude API Error:', error);
// Fall back to intelligent local responses
const lastUserMessage = messages[messages.length - 1].content;
return generateIntelligentResponse(lastUserMessage, messages);
}
}

// Enhanced local response system (fallback) with memory integration
function generateIntelligentResponse(userMessage, conversationHistory = []) {
const memories = getMemories();
const hasMemories = memories.length > 0;

const responses = {
// Depression with memory integration
depression: hasMemories ? [
"I can hear the sadness in what you're sharing, and I'm glad you feel comfortable coming back to talk with me. From our previous conversations, I remember you've been carrying some heavy feelings. What's been weighing on your heart most lately? How are these feelings comparing to when we last talked?",
        "Thank you for continuing to trust me with how you're feeling. I remember you've shared feelings of sadness with me before, and I want you to know that your feelings are completely valid. What does this sadness feel like for you today compared to when we've talked before? Sometimes our emotional experiences can shift and change over time."
] : [
        "I hear that you're feeling sad right now. That takes courage to share. What's been happening in your life that's bringing up this sadness? Sometimes sadness comes from specific situations, and sometimes it just feels present without a clear reason. I'm genuinely curious about what your experience has been like.",
        "When you say you're feeling sad, I can sense there's real pain there. What does this sadness feel like for you day-to-day? Is it more of a deep ache, or something that comes and goes in waves? I'm wondering what might be weighing on your heart right now.",
        "I can hear the heaviness in what you're sharing. Sadness can feel so overwhelming sometimes. What's your world looking like right now that's contributing to these feelings? I'm here to listen and understand what you're going through."
],

// Anxiety with memory integration 
anxiety: hasMemories ? [
        "I can sense the anxiety in what you're sharing, and I appreciate you coming back to talk with me about it. From what I remember of our previous conversations, you've been dealing with some worrying thoughts. What's been triggering your anxiety most recently? Are these similar concerns to what we've discussed before, or is this something new?",
        "I notice you're feeling scared or anxious again. I remember this has been something you've been working through. What does the anxiety feel like in your body and mind right now? Are you finding that any of the things we've talked about before are helping, or is this feeling different this time?"
] : [
        "I can hear that you're feeling scared right now. Fear can be such an overwhelming emotion, especially when it feels big and consuming. What's frightening you most at the moment? Sometimes naming our fears can help us understand them better and figure out what might help you feel safer.",
        "When you say you're feeling anxious or scared, I can sense there's real distress there. What does this fear feel like in your body and mind? Are there specific thoughts or situations that are triggering these feelings, or does the anxiety seem to come from nowhere?",
        "The anxiety you're describing sounds really intense. What's been happening in your life that's stirring up these worried feelings? Sometimes anxiety can be our mind's way of trying to protect us, but it can feel so overwhelming."
],

// Loneliness with memory integration
loneliness: hasMemories ? [
        "I hear that loneliness in your words, and it makes my heart go out to you. I remember you've shared feelings of being alone with me before, and I want you to know that reaching out here shows such strength. Has the loneliness been feeling the same as when we last talked, or has something shifted? What does connection look like for you right now?",
        "The loneliness you're describing sounds so painful, and I'm grateful you feel comfortable sharing that with me again. From our previous conversations, I can see this has been something you've been navigating for a while. What kind of connection are you most craving today? Is it similar to what we've talked about before, or has that feeling changed?"
] : [
        "I hear that you're feeling lonely right now. Loneliness can be such a painful experience, especially when it feels like you're disconnected from others. What does this loneliness look like for you? Are you physically alone, or is it more that feeling of being around people but still feeling unseen or misunderstood?",
        "When you say you feel lonely, I can sense there's a real ache there. What kind of connection are you most missing right now? Is it wanting close friendships, family connection, or maybe just someone who really understands what you're going through?",
        "That loneliness sounds really hard to carry. What's your daily life like right now in terms of connection with others? Sometimes loneliness can feel different depending on whether we're isolated or surrounded by people but feeling disconnected."
],

// Stress/Overwhelm with memory integration
overwhelmed: hasMemories ? [
        "I can sense you're feeling really overwhelmed right now. I remember from our previous talks that life has been throwing a lot at you. What's feeling most heavy or chaotic in your world today? Are these the same pressures we've discussed before, or are there new challenges piling up?",
        "It sounds like you're carrying so much right now. From what I remember of our conversations, you've been managing quite a bit. What part of everything you're dealing with feels most overwhelming today? I'm curious about what's making it feel impossible to manage."
] : [
        "I can hear that you're feeling really overwhelmed right now. When everything feels like too much, it can be hard to even know where to start. What's been piling up in your life that's making everything feel so heavy and chaotic?",
        "That overwhelmed feeling sounds exhausting. What does your daily life look like right now that's contributing to feeling like everything is too much? Sometimes breaking down what's overwhelming us can help us see it more clearly."
],

// Greeting - differentiated for new vs returning users
greeting: hasMemories ? [
        "Hello! It's so good to see you again. I've been thinking about our previous conversations and how you've been doing. What's been happening in your world since we last talked? I'm genuinely curious to hear how things have been going for you.",
        "Hi there! Welcome back. I remember some of the things you've shared with me before, and I'm really glad you feel comfortable coming back to talk. What's been on your mind lately? How are you feeling about the things we've discussed in our previous conversations?",
        "Hey! I'm so glad you're back. It means a lot that you continue to trust this space. What's been stirring in your thoughts and feelings since we last connected? I'm here and ready to listen to whatever you want to share."
] : [
        "Hello! I'm really glad you're here and that you've decided to reach out. This is your safe space to share whatever's truly on your mind. What brought you here today? Whether it's something specific weighing on you or you're just feeling a bit off and not sure why, I'm here to listen and explore it with you.",
        "Hi there! Thank you for taking the step to reach out today. I'm Eden, and I'm genuinely curious about what's happening in your world right now. What's been occupying your thoughts lately, or what made you want to talk to someone today? This is your space to be completely open and honest.",
        "Welcome! I'm so glad you found your way here. This is a space where you can be completely yourself and share whatever is on your heart or mind. What's been happening in your inner world that made you want to reach out today?"
],

// General with memory integration
general: hasMemories ? [
        "I can sense there's something on your mind, and I'm glad you came back to talk with me. Thinking about our previous conversations, I'm curious about what's been occupying your thoughts lately. Is this connected to some of the things we've discussed before, or is this something new that's come up for you?",
        "Thank you for continuing to trust me with what you're going through. I remember some of the things you've shared before, and I'm wondering how you've been processing those experiences. What feels most important for you to talk about today?",
        "I can tell there's something you want to explore, and I appreciate you coming back to this space. Based on what we've talked about before, I'm curious about what's been shifting or changing in your emotional world. What's drawing your attention today?"
] : [
        "I can sense there's something weighing on you. What's been occupying your thoughts lately? Sometimes just having space to talk through what's on our minds can help us process things better. What feels most important for you to share right now?",
        "It sounds like you're going through something. What's your inner world like at the moment? I'm genuinely curious about your experience and what's been feeling most challenging or confusing for you lately.",
        "I'm here and ready to listen to whatever you want to share. What's been happening in your life or in your thoughts that made you want to reach out today? This is your space to explore whatever feels important."
]
};

const lowerMessage = userMessage.toLowerCase();
let responseCategory = 'general';

// Enhanced detection logic
if (lowerMessage.includes('suicidal') || lowerMessage.includes('kill myself') || lowerMessage.includes('want to die') || 
lowerMessage.includes('end my life') || lowerMessage.includes('suicide') || lowerMessage.includes('self harm') || 
lowerMessage.includes('hurt myself') || lowerMessage.includes('better off dead') || lowerMessage.includes('no point living')) {
        // Crisis responses should go directly to professional help
        return { choices: [{ message: { content: "I'm really concerned about what you've shared with me about wanting to end your life. This sounds like you're in serious emotional pain right now. Your safety is the most important thing, and there are people specifically trained to help with these feelings:\n\n• US: 988 (Suicide & Crisis Lifeline) - 24/7\n• UK: 116 123 (Samaritans) - 24/7\n• Crisis Text: HOME to 741741\n\nAre you in immediate danger right now? Can you stay safe while we talk about getting you connected with crisis support?" } }] };
}
else if (lowerMessage.includes('anxious') || lowerMessage.includes('anxiety') || lowerMessage.includes('panic') || 
lowerMessage.includes('nervous') || lowerMessage.includes('worried') || lowerMessage.includes('scared') || 
lowerMessage.includes('afraid')) {
        responseCategory = 'anxiety';
}
else if (lowerMessage.includes('depressed') || lowerMessage.includes('depression') || lowerMessage.includes('sad') || 
lowerMessage.includes('hopeless') || lowerMessage.includes('down') || lowerMessage.includes('low')) {
        responseCategory = 'depression';
}
else if (lowerMessage.includes('lonely') || lowerMessage.includes('loneliness') || lowerMessage.includes('alone') || 
lowerMessage.includes('isolated') || lowerMessage.includes('no friends') || lowerMessage.includes('nobody cares')) {
        responseCategory = 'loneliness';
}
else if (lowerMessage.includes('overwhelmed') || lowerMessage.includes('stressed') || lowerMessage.includes('too much') ||
lowerMessage.includes('can\'t cope') || lowerMessage.includes('breaking down')) {
        responseCategory = 'overwhelmed';
}
else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey') ||
lowerMessage.includes('good morning') || lowerMessage.includes('good evening') || lowerMessage.includes('good afternoon')) {
        responseCategory = 'greeting';
}

// Get response from category
const categoryResponses = responses[responseCategory] || responses['general'];
const selectedResponse = categoryResponses[Math.floor(Math.random() * categoryResponses.length)];

return { choices: [{ message: { content: selectedResponse } }] };
}

async function sendMessage() {
const input = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const message = input.value.trim();

if (message === '') return;

sendButton.disabled = true;
input.disabled = true;

addMessage(message, 'user');
input.value = '';

showTypingIndicator();

try {
        conversationHistory.push({
            role: 'user',
            content: message
        });

        const data = await callClaude(conversationHistory);
        const aiResponse = data.choices[0].message.content.trim();

        // Save this interaction to memory
        const emotion = extractEmotion(message);
        saveMemory(message, aiResponse, emotion);

        conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });

        // Keep conversation history manageable
        if (conversationHistory.length > 21) {
            conversationHistory = [
                conversationHistory[0], // Keep system message
                ...conversationHistory.slice(-20)
            ];
        }

        hideTypingIndicator();
        addMessage(aiResponse, 'ai');

} catch (error) {
        hideTypingIndicator();
        console.error('Error:', error);

        const fallbackResponse = generateIntelligentResponse(message, conversationHistory);
        const response = fallbackResponse.choices[0].message.content;
        addMessage(response, 'ai');

        // Save fallback interaction to memory too
        const emotion = extractEmotion(message);
        saveMemory(message, response, emotion);
} finally {
        sendButton.disabled = false;
        input.disabled = false;
        input.focus();
}
}

function addMessage(content, sender) {
const chatArea = document.getElementById('chatArea');
const messageDiv = document.createElement('div');
messageDiv.className = `message ${sender}-message`;

if (sender === 'ai') {
        messageDiv.innerHTML = `
            <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
            <div class="ai-message-content">${content}</div>
        `;
} else {
        messageDiv.textContent = content;
}

if (sender === 'user') {
        const welcomeSection = document.querySelector('.welcome-section');
        if (welcomeSection) {
            welcomeSection.remove();
        }

        const logoHeader = document.getElementById('logoHeader');
        logoHeader.classList.add('compact');
}

chatArea.appendChild(messageDiv);
chatArea.scrollTop = chatArea.scrollHeight;
}

function showTypingIndicator() {
hideTypingIndicator();

const chatArea = document.getElementById('chatArea');
const typingDiv = document.createElement('div');
typingDiv.className = 'message ai-message';
typingDiv.id = 'currentTypingIndicator';
typingDiv.innerHTML = `
        <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
        <div class="thinking-heart">💚</div>
    `;

chatArea.appendChild(typingDiv);
chatArea.scrollTop = chatArea.scrollHeight;
}

function hideTypingIndicator() {
const existingIndicator = document.getElementById('currentTypingIndicator');
if (existingIndicator) {
        existingIndicator.remove();
}
}

function handleKeyPress(event) {
if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
}
}

// Initialize app with memory system
document.addEventListener('DOMContentLoaded', function() {
showDisclaimerModal();
document.getElementById('messageInput').focus();
});
</script>
</body>
</html>
