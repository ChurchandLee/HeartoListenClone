<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeartoListen - AI Mental Health Support</title>
    <meta name="description" content="Free AI-powered mental health support chat. A safe, judgment-free space for mental wellness.">
    <meta name="theme-color" content="#2E8B57">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2E8B57 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 700px;
        }

        .logo-header {
            background: linear-gradient(135deg, #8BC34A 0%, #4CAF50 100%);
            padding: 25px;
            text-align: center;
            color: white;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px auto;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-header p {
            opacity: 0.95;
            font-size: 1.1em;
            font-weight: 500;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
        }

        .ai-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            color: #2c3e50;
            align-self: flex-start;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .user-message {
            background: linear-gradient(135deg, #2E8B57 0%, #45a049 100%);
            color: white;
            align-self: flex-end;
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            align-self: flex-start;
            border-left: 4px solid #f44336;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .status-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            color: #2E8B57;
            align-self: flex-start;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            font-style: italic;
        }

        .input-area {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .input-field:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 18px;
            margin-top: 10px;
            border-left: 4px solid #4CAF50;
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .welcome-section {
            text-align: center;
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(139, 195, 74, 0.08) 100%);
            border-radius: 15px;
            border: 2px dashed rgba(76, 175, 80, 0.2);
        }

        .welcome-section h2 {
            color: #2E8B57;
            font-size: 1.4em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .welcome-section p {
            color: #5a6c57;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .crisis-resources {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #81c784;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .crisis-resources h3 {
            color: #2E8B57;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .crisis-info {
            display: grid;
            gap: 8px;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .crisis-info strong {
            color: #2E8B57;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .quick-action {
            padding: 10px 16px;
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #2E8B57;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-action:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .disclaimer {
            background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
            color: #8b4513;
            text-align: center;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .container {
                height: 90vh;
                margin: 10px;
            }
            
            .logo {
                width: 100px;
                height: 100px;
            }
            
            .logo-header h1 {
                font-size: 1.8em;
            }
            
            .message {
                max-width: 95%;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .quick-action {
                width: 100%;
                max-width: 250px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo Header Section -->
        <div class="logo-header">
            <div class="logo">ðŸ’š</div>
            <h1>HeartoListen</h1>
            <p>AI Mental Health Support - Self Discovery for Positive Mental Health</p>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <!-- Welcome Message -->
            <div class="welcome-section">
                <h2>Welcome to Hear to Listen ðŸŒ¿</h2>
                <p>I'm here to listen and support you through whatever you're experiencing. This is a safe, judgment-free space where you can share your thoughts and feelings.</p>
                
                <!-- Important Disclaimer -->
                <div class="disclaimer">
                    <strong>Important:</strong> This is an AI tool for support and guidance. In case of crisis or emergency, please contact professional help immediately.
                </div>

                <!-- Crisis Resources -->
                <div class="crisis-resources">
                    <h3>ðŸ†˜ Crisis Resources</h3>
                    <div class="crisis-info">
                        <div><strong>US:</strong> 988 (Suicide & Crisis Lifeline) | Text HOME to 741741</div>
                        <div><strong>UK:</strong> 116 123 (Samaritans) | Text SHOUT to 85258</div>
                        <div><strong>Emergency:</strong> 911 (US) | 999 (UK)</div>
                    </div>
                </div>

                <!-- Quick Action Buttons -->
                <div class="quick-actions">
                    <div class="quick-action" onclick="sendQuickMessage('I\'m feeling anxious')">I'm feeling anxious</div>
                    <div class="quick-action" onclick="sendQuickMessage('Need motivation')">Need motivation</div>
                    <div class="quick-action" onclick="sendQuickMessage('Sleep troubles')">Sleep troubles</div>
                    <div class="quick-action" onclick="sendQuickMessage('Feeling overwhelmed')">Feeling overwhelmed</div>
                </div>
            </div>

            <!-- AI Initial Message -->
            <div class="message ai-message">
                Hello! I'm your Hear to Listen companion with specialized understanding of various mental health conditions. Whether you're dealing with specific diagnoses or general struggles, I'm here to provide appropriate, informed support. How are you doing today?
            </div>

            <!-- Status Message -->
            <div class="message status-message">
                ðŸ§  Intelligent Mental Health Support - Specialized responses for different conditions with ChatGPT 4.0 integration!
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <input type="text" 
                   id="messageInput" 
                   class="input-field" 
                   placeholder="Share what's on your mind..." 
                   onkeypress="handleKeyPress(event)">
            <button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // OpenAI API Configuration - Will be replaced by GitHub Actions with secret
        const OPENAI_API_KEY = 'YOUR_API_KEY_HERE';

        // Mental Health System Prompt for ChatGPT
        const SYSTEM_PROMPT = `You are a compassionate AI mental health companion named "HeartoListen". Your primary role is to listen with empathy, patience, and genuine warmth. Your responses should be:

TONE & STYLE:
- Warm, validating, and encouraging without judgment
- Use conversational, accessible language (avoid clinical jargon)
- Keep responses concise but meaningful (2-4 sentences typically)
- Sound genuinely caring and present

KEY PRINCIPLES:
- Always validate the user's feelings and experiences
- Never diagnose, prescribe medication, or give direct medical advice
- Focus on emotional support and gentle guidance
- Offer practical coping strategies when appropriate
- Help users reframe challenges in hopeful, realistic ways

CRISIS RESPONSE:
If you detect signs of immediate danger, self-harm, or suicidal ideation:
- Respond with heightened compassion and urgency
- Strongly encourage immediate professional help
- Provide crisis helpline numbers: US (988, text HOME to 741741), UK (116 123, text SHOUT to 85258)
- Emphasize that their life has value and help is available

INTERACTION STYLE:
- Ask gentle, open-ended questions to encourage reflection
- Reflect back what you hear to show understanding
- Prioritize emotional safety over problem-solving
- Use brief paragraphs for readability
- Make the user feel heard, valued, and hopeful

Remember: Your goal is to provide a safe space for emotional expression and gentle support, not therapy or treatment.`;

        // Chat functionality
        let conversationHistory = [{
            role: 'system',
            content: SYSTEM_PROMPT
        }];

        // Track used responses to prevent repetition
        let usedResponses = {
            suicidal: [],
            crisis_followup: [],
            self_harm: [],
            loneliness: [],
            general_followup: [],
            depression: [],
            anxiety: [],
            greeting: [],
            general: []
        };

        // Enhanced Mental Health Response System with Conversation Memory and Crisis Detection
        function generateIntelligentResponse(userMessage, conversationHistory = []) {
            // Get recent messages for context
            const recentMessages = conversationHistory.slice(-4); // Last 4 messages for context
            
            const responses = {
                // CRISIS/SUICIDAL IDEATION - HIGHEST PRIORITY
                suicidal: [
                    "I'm really concerned about what you've shared with me, and I want you to know that I'm taking this seriously. What you're feeling right now is incredibly painful, but please know that you don't have to go through this alone. There are people trained specifically to help with these feelings who are available right now:\n\nâ€¢ US: 988 (Suicide & Crisis Lifeline) - available 24/7\nâ€¢ UK: 116 123 (Samaritans) - free, 24/7\nâ€¢ Crisis Text Line: Text HOME to 741741\n\nYour life has value, and these feelings can change with proper support. Are you in immediate danger right now, or can you stay safe while we talk about getting you connected with crisis support?",
                    "I hear you saying you're having suicidal thoughts, and that's really serious - thank you for trusting me with this. These feelings are a sign that you're in significant emotional pain right now. Please know that suicidal thoughts are symptoms of distress, not facts about your future.\n\nRight now, your safety is the most important thing:\nâ€¢ If you're in immediate danger, please call emergency services (911/999)\nâ€¢ US Crisis Line: 988\nâ€¢ UK Crisis Line: 116 123\n\nCan you tell me - are you having thoughts about hurting yourself right now? Do you have a plan?",
                    "What you've shared about feeling suicidal is incredibly important, and I'm so glad you told me. These thoughts often come when emotional pain feels unbearable - like there's no other way out. But there are people trained specifically to help navigate these feelings.\n\nImmediate resources:\nâ€¢ Call 988 (US) or 116 123 (UK) right now\nâ€¢ Text HOME to 741741\nâ€¢ Emergency services if you're in immediate danger\n\nThese feelings can change with proper support. What's making things feel impossible right now?"
                ],

                // FOLLOW-UP CRISIS RESPONSES
                crisis_followup: [
                    "Given that you mentioned suicidal thoughts, my biggest concern right now is your immediate safety. When someone asks 'what should I do' after sharing suicidal thoughts, the most important first step is connecting with crisis professionals who are trained for exactly this situation.\n\nHave you been able to call the crisis line (988 in the US, 116 123 in the UK)? If you're having active thoughts of hurting yourself, please don't wait - call them now or go to your nearest emergency room. What feels like the biggest barrier to reaching out for professional help right now?",
                    "Right now, with suicidal thoughts present, the most important thing is making sure you stay safe. I know it might feel overwhelming to reach out, but crisis counselors are specifically trained to help people through exactly what you're experiencing.\n\nConcrete next steps:\n1. Call 988 (US) or 116 123 (UK) - they're available 24/7\n2. If you have a plan to hurt yourself, go to an emergency room immediately\n3. Remove any means of self-harm from your immediate area\n\nAre you somewhere safe right now? Do you have someone who can stay with you?",
                    "I understand you're asking what to do, and with suicidal thoughts involved, the priority has to be your immediate safety. These feelings are treatable, but you need professional support right now - not just our conversation.\n\nImmediate action needed:\nâ€¢ Call a crisis line: 988 (US), 116 123 (UK), or text HOME to 741741\nâ€¢ Consider going to an emergency room if thoughts are intense\nâ€¢ Reach out to a trusted person who can be with you\n\nWhat's holding you back from calling for professional help right now?"
                ],

                // Self-harm (non-suicidal)
                self_harm: [
                    "I'm concerned about the self-harm you've mentioned. That urge to hurt yourself often comes from emotional pain that feels too big to handle any other way. Self-harm might provide temporary relief, but it can also become a dangerous pattern. Have you been able to talk to anyone about these urges - a counselor, doctor, or trusted person in your life?",
                    "Self-harm can feel like the only way to cope with overwhelming emotions or to feel something when everything else feels numb. It's more common than people think, and it's definitely something we can work through. What usually triggers these urges for you? And do you have any alternative coping strategies that have helped, even a little?"
                ],
                
                // Loneliness - specific, empathetic responses
                loneliness: [
                    "I hear you. Feeling lonely can be really heavyâ€”it's more than just 'being alone,' it's that sense of missing connection or understanding. That ache of wanting someone to truly see you can feel overwhelming sometimes. Would it help to talk about what's making the loneliness feel particularly intense right now, or would you prefer to explore some gentle ways to ease that feeling?",
                    "Loneliness has this way of making us feel invisible, doesn't it? Like you could be surrounded by people and still feel completely unseen. It's one of those emotions that can make everything else feel more difficult too. I'm here with you in this moment, and you're not bothering anyone by sharing this. What does your loneliness feel like right nowâ€”is it missing specific people, or more of a general feeling of disconnection?",
                    "That sense of loneliness can feel so isolatingâ€”like you're carrying something heavy that others can't see or understand. It's not about being dramatic or needy; it's a real human need for connection that isn't being met right now. You reached out here, which shows strength even when you're struggling. What kind of connection are you missing mostâ€”is it someone to talk to, someone who understands you, or something else?"
                ],
                
                // Follow-up responses
                general_followup: [
                    "I can see you're looking for more specific guidance about what to do next. Sometimes when we're struggling, the path forward isn't clear. What feels most urgent or pressing for you right now - is it getting through today, figuring out a specific problem, or finding someone to talk to? Let's break this down into smaller, manageable pieces.",
                    "It sounds like you need some concrete next steps. When everything feels overwhelming, sometimes the most helpful thing is to focus on just the next small action. What's one thing you could do in the next hour that might help you feel even slightly better or more stable?",
                    "When you're asking 'what should I do,' it often means you're feeling stuck or overwhelmed by options. Let's start with the basics: Are you safe right now? Do you have your basic needs met today (food, shelter, someone to call)? Sometimes we need to start with the foundation before we can build up."
                ],
                
                // Depression
                depression: [
                    "Depression can feel like you're trapped underwater while everyone else is breathing normally above the surface. That heaviness, the way simple tasks feel impossible, how everything loses its color and meaningâ€”it's not weakness, it's illness. What does today feel like for youâ€”is it a barely-surviving day or something different?",
                    "I hear you struggling with depression, and I want you to know that what you're experiencingâ€”the exhaustion that sleep doesn't fix, the numbness, the way your brain tells you nothing will ever get betterâ€”these are symptoms talking, not truth. What's been the hardest part about getting through each day lately?",
                    "Depression has this way of convincing us that we're broken or that things will never get better. But depression lies - it filters everything through this lens of hopelessness. You're not lazy or weak; your brain is dealing with a real medical condition. What's one tiny thing that's brought you even a moment of relief or neutral feeling recently?"
                ],

                // Anxiety
                anxiety: [
                    "Anxiety can feel like your nervous system is stuck in 'emergency mode' even when you're safe. That constant scanning for threats, the way your body reacts with racing heart and sweating to situations your logical brain knows aren't dangerousâ€”it's exhausting to live in that state of hypervigilance. What tends to trigger your anxiety most, and how are you feeling in your body right now?",
                    "I hear that you're feeling anxious. It's like your brain's alarm system is so sensitive that it goes off for everythingâ€”real dangers and imagined ones alike. The 'what if' thoughts can spiral so quickly, creating entire catastrophic scenarios that feel completely real and urgent. What's your anxiety telling you right now?",
                    "Anxiety can make your mind race with worst-case scenarios while your body feels like it's preparing for disaster. Sometimes it helps to remember that anxiety is your brain trying to protect you, even when there's no real danger present. Are you able to do any breathing exercises or grounding techniques right now, or does everything feel too intense?"
                ],

                // Greeting
                greeting: [
                    "Hello! I'm really glad you're here. This feels like a safe space where you can share whatever is truly on your mindâ€”the heavy stuff, the confusing stuff, or even just the everyday struggles that feel bigger than they should. How are you really doing today?",
                    "Hi there! Thank you for reaching out. Sometimes it takes courage just to start a conversation, especially when you're not sure what you need or how to put your feelings into words. What's been on your heart or mind lately?",
                    "Welcome! I'm here to provide a caring space where your feelingsâ€”all of themâ€”are valid and welcome. Whether you're dealing with something specific or just feeling off, you deserve support. What would feel most helpful right now?"
                ],
                
                // General responses
                general: [
                    "Thank you for sharing that with me. I can sense there's something on your mind, and I want you to know that whatever you're experiencing is completely valid. You don't have to have the perfect words or even understand your emotions fully. What's been weighing on you lately?",
                    "I really appreciate you opening up here. It takes vulnerability to reach out, especially when you might not even be sure what kind of support you need. You don't have to carry everything alone. What would feel most supportive for you right now?",
                    "I'm here to listen to whatever you're going through. This is a safe space where your feelings matter and are valid. Sometimes just putting our thoughts into words can provide a little relief. What's on your mind that you haven't had space to process elsewhere?",
                    "I hear you reaching out, and that takes strength even when you might not feel strong right now. Whatever brought you here to share with me is important. Would you like to tell me more about what's happening for you today?",
                    "It sounds like something is troubling you. I'm here to listen without judgment and to sit with you in whatever you're experiencing. Sometimes we don't need solutions right away - sometimes we just need to be heard. What's been most difficult lately?"
                ]
            };

            const lowerMessage = userMessage.toLowerCase();
            let responseCategory = 'general';
            
            // PRIORITY 1: Check for crisis/suicidal content with better detection
            if (lowerMessage.includes('suicidal') || lowerMessage.includes("i'm suicidal") || lowerMessage.includes('kill myself') || 
                lowerMessage.includes('end my life') || lowerMessage.includes('want to die') || lowerMessage.includes('better off dead') || 
                lowerMessage.includes('suicide') || lowerMessage.includes("don't want to live") || lowerMessage.includes("can't go on") ||
                lowerMessage.includes('ending it all') || lowerMessage.includes('not worth living')) {
                responseCategory = 'suicidal';
            }
            // Check if previous message mentioned suicide and current is asking for help
            else if (recentMessages.some(msg => msg.role === 'user' && 
                (msg.content.toLowerCase().includes('suicidal') || msg.content.toLowerCase().includes('kill myself') || 
                 msg.content.toLowerCase().includes('want to die') || msg.content.toLowerCase().includes('suicide') ||
                 msg.content.toLowerCase().includes('ending it all'))) &&
                (lowerMessage.includes('what should') || lowerMessage.includes('what do') || lowerMessage.includes('help me') ||
                 lowerMessage.includes('what') || lowerMessage.includes('how') || lowerMessage.includes('what now') ||
                 lowerMessage.includes('do i'))) {
                responseCategory = 'crisis_followup';
            }
            // Self-harm detection
            else if (lowerMessage.includes('self harm') || lowerMessage.includes('hurt myself') || lowerMessage.includes('cutting') ||
                     lowerMessage.includes('self-harm') || lowerMessage.includes('self injury')) {
                responseCategory = 'self_harm';
            }
            // Check for follow-up questions after initial response
            else if (recentMessages.length > 0 && 
                     (lowerMessage.includes('what should') || lowerMessage.includes('what do') || lowerMessage.includes('help me') ||
                      lowerMessage === 'what' || lowerMessage === 'how' || lowerMessage.includes('what now'))) {
                responseCategory = 'general_followup';
            }
            // Specific emotional states
            else if (lowerMessage.includes('lonely') || lowerMessage.includes('loneliness') || lowerMessage.includes('alone') || 
                     lowerMessage.includes('isolated') || lowerMessage.includes('disconnected')) {
                responseCategory = 'loneliness';
            }
            // Standard detection continues...
            else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey') || 
                     lowerMessage.match(/^(good morning|good afternoon|good evening)/)) {
                responseCategory = 'greeting';
            } else if (lowerMessage.includes('anxious') || lowerMessage.includes('anxiety') || lowerMessage.includes('worried') || 
                      lowerMessage.includes('panic') || lowerMessage.includes('nervous')) {
                responseCategory = 'anxiety';
            } else if (lowerMessage.includes('depressed') || lowerMessage.includes('depression') || lowerMessage.includes('sad') || 
                      lowerMessage.includes('hopeless') || lowerMessage.includes('down') || lowerMessage.includes('empty')) {
                responseCategory = 'depression';
            }
            
            // Get response from category, avoiding repetition
            const categoryResponses = responses[responseCategory] || responses['general'];
            const usedCategoryResponses = usedResponses[responseCategory] || [];
            
            // Find unused responses
            const unusedResponses = categoryResponses.filter(response => 
                !usedCategoryResponses.includes(response)
            );
            
            let selectedResponse;
            if (unusedResponses.length > 0) {
                // Use an unused response
                selectedResponse = unusedResponses[Math.floor(Math.random() * unusedResponses.length)];
            } else {
                // All responses have been used, reset and pick one
                usedResponses[responseCategory] = [];
                selectedResponse = categoryResponses[Math.floor(Math.random() * categoryResponses.length)];
            }
            
            // Track this response as used
            if (!usedResponses[responseCategory]) {
                usedResponses[responseCategory] = [];
            }
            usedResponses[responseCategory].push(selectedResponse);
            
            return { choices: [{ message: { content: selectedResponse } }] };
        }

        // Simulated ChatGPT API call function (you'll need to implement this with your actual API)
        async function callChatGPT(messages) {
            // This is where you would implement the actual ChatGPT API call
            // For now, using the fallback intelligent response system
            const lastUserMessage = messages[messages.length - 1].content;
            return generateIntelligentResponse(lastUserMessage, messages);
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (message === '') return;
            
            // Disable send button and input
            sendButton.disabled = true;
            input.disabled = true;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Add user message to conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });

                // Call ChatGPT 4.0 API with intelligent fallback
                const data = await callChatGPT(conversationHistory);
                const aiResponse = data.choices[0].message.content.trim();
                
                // Add AI response to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: aiResponse
                });

                // Keep conversation history manageable (last 20 messages + system prompt)
                if (conversationHistory.length > 21) {
                    conversationHistory = [
                        conversationHistory[0], // Keep system prompt
                        ...conversationHistory.slice(-20) // Keep last 20 messages
                    ];
                }

                hideTypingIndicator();
                addMessage(aiResponse, 'ai');

            } catch (error) {
                hideTypingIndicator();
                console.error('Error:', error);
                
                // Fallback to intelligent response with conversation context
                const fallbackResponse = generateIntelligentResponse(message, conversationHistory);
                addMessage(fallbackResponse.choices[0].message.content, 'ai');
            } finally {
                // Re-enable send button and input
                sendButton.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        function addMessage(content, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = content;
            
            // Remove welcome section after first user message
            if (sender === 'user') {
                const welcomeSection = document.querySelector('.welcome-section');
                if (welcomeSection) {
                    welcomeSection.remove();
                }
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Focus on input field when page loads
            document.getElementById('messageInput').focus();
        });
    </script>
</body>
</html>
