<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeartoListen - AI Mental Wellbeing Support</title>
    <meta name="description" content="Free AI-powered Mental Wellbeing Support Companion. Your 24/7 safe, private and judgement-free space for mental wellness.">
    <meta name="theme-color" content="#8eaf78">
    
    <!-- PWA and App Icon Meta Tags -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HeartoListen">
    
    <!-- Android specific -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8eaf78 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-image: url('https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/fern background.png');
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 700px;
        }

        .logo-header {
            background: linear-gradient(135deg, #5f795a 0%, #4CAF50 100%);
            padding: 25px;
            text-align: center;
            color: white;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .logo-header.compact {
            padding: 15px;
        }

        .logo {
            width: 150px;
            height: 150px;
            margin: 0 auto 15px auto;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .logo-header.compact .logo {
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .logo-header p {
            opacity: 0.95;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logo-header.compact h1,
        .logo-header.compact p {
            display: none;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
        }

        .ai-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            color: #274e13;
            align-self: flex-start;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px 20px;
        }

        .ai-message-content {
            flex: 1;
            line-height: 1.6;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(76, 175, 80, 0.3);
            object-fit: cover;
            object-position: center;
            flex-shrink: 0;
        }

        .user-message {
            background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
            color: white;
            align-self: flex-end;
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            align-self: flex-start;
            border-left: 4px solid #f44336;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .thinking-heart {
            font-size: 24px;
            animation: heartPulse 1.5s ease-in-out infinite;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .welcome-section {
            text-align: center;
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(139, 195, 74, 0.08) 100%);
            border-radius: 15px;
            border: 2px dashed rgba(76, 175, 80, 0.2);
        }

        .welcome-section h2 {
            color: #8eaf78;
            font-size: 1.4em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .welcome-section p {
            color: #5a6c57;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .memory-recap {
            background: linear-gradient(135deg, rgba(142, 175, 120, 0.08) 0%, rgba(255, 223, 186, 0.08) 100%);
            border: 2px dashed rgba(142, 175, 120, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
            color: #5a6c57;
            text-align: left;
        }

        .memory-recap h4 {
            color: #8eaf78;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .memory-recap ul {
            padding-left: 20px;
            margin: 0;
        }

        .memory-recap li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
            color: #8b4513;
            text-align: center;
            font-weight: 500;
        }

        .input-area {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .input-field:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes heartPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }

        /* DISCLAIMER MODAL STYLES */
        .disclaimer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .disclaimer-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: left;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: disclaimerSlideIn 0.4s ease-out;
            border: 3px solid #8eaf78;
        }

        .disclaimer-modal h2 {
            color: #8eaf78;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }

        .disclaimer-modal .warning-icon {
            text-align: center;
            font-size: 3em;
            margin-bottom: 15px;
        }

        .disclaimer-content {
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .disclaimer-content p {
            margin-bottom: 15px;
        }

        .disclaimer-content strong {
            color: #2c5530;
            font-weight: 600;
        }

        .emergency-section {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border: 2px solid #e91e63;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .emergency-section h3 {
            color: #c2185b;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .emergency-contacts {
            margin: 15px 0;
            padding-left: 20px;
        }

        .emergency-contacts li {
            margin-bottom: 8px;
            color: #880e4f;
            font-weight: 500;
        }

        .important-notes {
            background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .important-notes h3 {
            color: #e67e22;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .important-notes ul {
            padding-left: 20px;
        }

        .important-notes li {
            margin-bottom: 8px;
            color: #8b4513;
        }

        .disclaimer-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-accept {
            background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .btn-accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(142, 175, 120, 0.3);
        }

        .btn-help {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(233, 30, 99, 0.3);
        }

        @keyframes disclaimerSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .container {
                height: 90vh;
                margin: 10px;
            }
            
            .logo {
                width: 120px;
                height: 120px;
            }

            .logo-header.compact .logo {
                width: 50px;
                height: 50px;
            }
            
            .logo-header h1 {
                font-size: 1.8em;
            }
            
            .message {
                max-width: 95%;
            }

            .disclaimer-modal {
                padding: 20px;
                margin: 10px;
                max-height: 90vh;
            }
            
            .disclaimer-modal h2 {
                font-size: 1.5em;
            }
            
            .disclaimer-content {
                font-size: 13px;
            }
            
            .disclaimer-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-accept,
            .btn-help {
                width: 100%;
                max-width: 250px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- DISCLAIMER MODAL -->
    <div id="disclaimerOverlay" class="disclaimer-overlay hidden">
        <div class="disclaimer-modal">
            <div class="warning-icon">⚠️</div>
            <h2>Important Disclaimer</h2>
            
            <div class="disclaimer-content">
                <p><strong>This app is designed to provide emotional support, encouragement, and validation. It is not a substitute for professional medical, psychiatric, or psychological treatment.</strong></p>
                
                <p>The content and features within this app are for general well-being, personal growth, and self-reflection purposes only. We are not medical professionals, and this app does not offer medical, clinical, or therapeutic advice.</p>
                
                <p>If you are experiencing significant distress, a mental health crisis, or believe you may have a condition requiring diagnosis or treatment, please seek help from a qualified healthcare provider.</p>
                
                <div class="important-notes">
                    <h3>📋 Important Notes</h3>
                    <ul>
                        <li>The app does not provide diagnosis, treatment, prescriptions, or medical interventions.</li>
                        <li>Use of this app is voluntary and should be considered a complementary tool to professional care, not a replacement.</li>
                        <li>Any decisions you make based on the information, tools, or suggestions provided are your personal responsibility.</li>
                    </ul>
                </div>
                
                <p><strong>By using this app, you acknowledge and agree that it is intended to provide support, validation, and helpful resources, but it cannot and does not replace the care of licensed professionals.</strong></p>
            </div>
            
            <div class="disclaimer-buttons">
                <button class="btn-accept" onclick="acceptDisclaimer()">I Understand & Agree</button>
                <button class="btn-help" onclick="getNeedHelpNow()">I Need Help Now</button>
            </div>
            
            <div class="emergency-section">
                <h3>🚨 Emergency Situations</h3>
                <p><strong>If you are in immediate danger or experiencing thoughts of harming yourself or others, please call your local emergency number right away.</strong></p>
                
                <ul class="emergency-contacts">
                    <li><strong>In the U.S.:</strong> you can dial 988 for the Suicide & Crisis Lifeline</li>
                    <li><strong>In the U.K. & Ireland:</strong> you can call Samaritans at 116 123</li>
                    <li><strong>In Australia:</strong> you can call Lifeline at 13 11 14</li>
                </ul>
                
                <p>If you are outside these regions, please look up local emergency and crisis services in your area.</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Logo Header Section -->
        <div class="logo-header" id="logoHeader">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png" alt="HeartoListen Logo" style="width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 10;">
            </div>   
            <h1>HeartoListen</h1>
            <p>AI Mental Wellbeing Support - Self Discovery for Positive Mental Health</p>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <!-- Welcome Message -->
            <div class="welcome-section" id="welcomeSection">
                <h2>Welcome to Hear to Listen</h2>
                <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                    <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(76, 175, 80, 0.3); object-fit: cover; object-position: center;">
                    <p style="margin: 0;">I'm Eden and I am here to listen and support you through whatever you're experiencing. This is a safe, judgement-free space where you can share your thoughts and feelings.</p>
                </div>

                <!-- Memory Recap Section (hidden initially) -->
                <div class="memory-recap" id="memoryRecap" style="display: none;">
                    <h4>Previous conversations:</h4>
                    <ul id="memoryList"></ul>
                </div>
                
                <!-- Important Disclaimer -->
                <div class="disclaimer">
                    <strong>⚠️ Important Safety Information:</strong>
                    <br><br>
                    <strong>Crisis Support:</strong> If you're having thoughts of suicide or self-harm, please reach out immediately:
                    <br>• <strong>UK:</strong> 999 (Emergency) | 116 123 (Samaritans - 24/7 free)
                    <br>• <strong>USA:</strong> 911 (Emergency) | 988 (Suicide & Crisis Lifeline)
                    <br>• <strong>Crisis Text:</strong> Text HOME to 741741
                    <br><br>
                    <strong>This app provides peer support and guidance, not professional medical advice.</strong> For ongoing mental health concerns, please seek professional Mental Wellbeing Support
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <input type="text" 
                   id="messageInput" 
                   class="input-field" 
                   placeholder="What's on your mind......" 
                   onkeypress="handleKeyPress(event)">
            <button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Enhanced Memory system with 30-day persistence
        let memories = [];
        let currentConversation = [];
        const MAX_MEMORIES = 50;
        const MAX_USERS = 100;
        let userCount = 0;
        let hasSeenDisclaimer = false;
        const MEMORY_EXPIRY_DAYS = 30;

        // Enhanced AI Response System with Contextual Understanding
        class EdenAI {
            constructor() {
                this.conversationContext = [];
                this.userProfile = {
                    commonThemes: [],
                    emotionalPatterns: [],
                    preferredSupport: null,
                    currentStruggles: []
                };
            }

            analyzeMessage(message) {
                const analysis = {
                    emotion: this.detectEmotion(message),
                    themes: this.extractThemes(message),
                    urgency: this.assessUrgency(message),
                    tone: this.detectTone(message),
                    keywords: this.extractKeywords(message)
                };
                return analysis;
            }

            detectEmotion(message) {
                const lowerMessage = message.toLowerCase();
                const emotions = {
                    grief: ['grief', 'grieving', 'loss', 'died', 'death', 'funeral', 'miss', 'passed away'],
                    anxiety: ['anxious', 'worried', 'panic', 'scared', 'nervous', 'afraid', 'fear'],
                    depression: ['sad', 'depressed', 'hopeless', 'empty', 'numb', 'worthless', 'down'],
                    anger: ['angry', 'frustrated', 'mad', 'furious', 'irritated', 'rage'],
                    loneliness: ['lonely', 'alone', 'isolated', 'disconnected', 'nobody cares'],
                    stress: ['stressed', 'overwhelmed', 'pressure', 'too much', 'exhausted'],
                    hope: ['better', 'improving', 'hopeful', 'good day', 'progress'],
                    gratitude: ['thank', 'grateful', 'appreciate', 'helped']
                };

                for (const [emotion, keywords] of Object.entries(emotions)) {
                    if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                        return emotion;
                    }
                }
                return 'neutral';
            }

            extractThemes(message) {
                const lowerMessage = message.toLowerCase();
                const themes = [];
                
                if (lowerMessage.match(/work|job|career|boss|colleague/)) themes.push('work');
                if (lowerMessage.match(/family|parent|mother|father|sibling/)) themes.push('family');
                if (lowerMessage.match(/relationship|partner|boyfriend|girlfriend|spouse/)) themes.push('relationships');
                if (lowerMessage.match(/school|study|exam|university|college/)) themes.push('education');
                if (lowerMessage.match(/health|sick|pain|medical|doctor/)) themes.push('health');
                if (lowerMessage.match(/money|financial|job|unemployment|debt/)) themes.push('financial');
                if (lowerMessage.match(/friend|social|party|people/)) themes.push('social');
                
                return themes;
            }

            assessUrgency(message) {
                const lowerMessage = message.toLowerCase();
                const highUrgency = ['suicide', 'kill myself', 'end it all', 'can\'t go on', 'hurt myself'];
                const mediumUrgency = ['crisis', 'emergency', 'help me', 'desperate', 'can\'t cope'];
                
                if (highUrgency.some(phrase => lowerMessage.includes(phrase))) return 'high';
                if (mediumUrgency.some(phrase => lowerMessage.includes(phrase))) return 'medium';
                return 'low';
            }

            detectTone(message) {
                const lowerMessage = message.toLowerCase();
                if (lowerMessage.match(/\?/)) return 'questioning';
                if (lowerMessage.match(/\!/)) return 'emotional';
                if (lowerMessage.length < 20) return 'brief';
                return 'narrative';
            }

            extractKeywords(message) {
                const words = message.toLowerCase().split(/\s+/);
                const meaningfulWords = words.filter(word => 
                    word.length > 3 && 
                    !['that', 'this', 'with', 'have', 'been', 'they', 'them', 'were', 'said', 'like', 'just', 'some', 'time'].includes(word)
                );
                return meaningfulWords.slice(0, 5);
            }

            generateContextualResponse(message, analysis, conversationHistory, memories) {
                // Check for crisis situation first
                if (analysis.urgency === 'high') {
                    return "I'm really concerned about what you've shared. Your life has value and you matter. Please reach out to a crisis helpline right now - in the UK call 999 or Samaritans at 116 123, in the US call 988. I'm here too, but please get immediate professional support. You don't have to go through this alone.";
                }

                // Build context from conversation and memories
                let context = this.buildContext(conversationHistory, memories, analysis);
                
                // Generate response based on emotion and context
                return this.craftPersonalizedResponse(message, analysis, context);
            }

            buildContext(conversationHistory, memories, analysis) {
                let context = {
                    previousTopics: [],
                    emotionalJourney: [],
                    supportStrategies: [],
                    relationshipDynamics: 'new'
                };

                // Analyze recent conversation
                if (conversationHistory.length > 0) {
                    context.relationshipDynamics = conversationHistory.length > 3 ? 'established' : 'developing';
                    conversationHistory.forEach(msg => {
                        if (msg.themes) context.previousTopics.push(...msg.themes);
                        if (msg.emotion) context.emotionalJourney.push(msg.emotion);
                    });
                }

                // Analyze historical memories
                if (memories.length > 0) {
                    context.relationshipDynamics = 'returning';
                    memories.slice(0, 5).forEach(memory => {
                        if (memory.emotion) context.emotionalJourney.push(memory.emotion);
                    });
                }

                return context;
            }

            craftPersonalizedResponse(message, analysis, context) {
                const { emotion, themes, tone } = analysis;
                const isReturning = context.relationshipDynamics === 'returning';
                const isEstablished = context.relationshipDynamics === 'established';

                // Handle specific emotions with context awareness
                switch (emotion) {
                    case 'grief':
                        if (isReturning) {
                            return `I remember you've been carrying this weight of grief. Thank you for coming back and continuing to share with me. Grief isn't linear - some days feel harder than others. What's grief feeling like for you right now, today?`;
                        }
                        return `I can hear the heaviness in your words. Grief is one of the most profound human experiences, and it takes immense courage to even name it. There's no right or wrong way to grieve. Would you like to tell me about what you've lost, or would you prefer to talk about how the grief is affecting you day to day?`;

                    case 'anxiety':
                        if (isEstablished && context.emotionalJourney.includes('anxiety')) {
                            return `I notice anxiety is visiting you again. We've talked about this before, and I want you to know that having recurring anxiety doesn't mean you're not making progress. What's triggering these anxious feelings today? Is it similar to what we discussed before, or something new?`;
                        }
                        return `Anxiety can feel so overwhelming, like your mind is racing ahead to all the things that could go wrong. I'm here with you in this moment. Can you tell me what's making you feel most anxious right now? Sometimes just naming it can help a little.`;

                    case 'depression':
                        if (themes.includes('work') || themes.includes('relationships')) {
                            return `Depression has this way of making everything feel harder, especially ${themes.includes('work') ? 'work' : 'relationships'}. It's like trying to swim through thick water. You don't have to carry this alone. What's been the hardest part about getting through your days lately?`;
                        }
                        return `I can feel the weight you're carrying right now. Depression can make even small things feel impossibly difficult. You took a step by reaching out today, and that matters. What's one thing that's been especially hard for you recently?`;

                    case 'hope':
                        if (context.emotionalJourney.some(e => ['depression', 'anxiety', 'grief'].includes(e))) {
                            return `It's really meaningful to hear some hope in your voice, especially after what you've been going through. These glimpses of hope are precious - they remind us that feelings do shift and change. What's contributing to this sense of hope today?`;
                        }
                        return `I can sense some hope and positivity in what you're sharing, and that's wonderful. It's beautiful when we can recognize these lighter moments. What's been helping you feel this way?`;

                    default:
                        // Contextual default responses
                        if (isReturning) {
                            return `It's good to have you back. I've been thinking about our previous conversations, and I'm glad you felt comfortable returning to share more with me. What's been on your mind since we last talked?`;
                        } else if (isEstablished) {
                            return `I'm really listening to what you're saying. Based on what you've shared with me, it sounds like you're processing something important. Can you help me understand what's most pressing for you right now?`;
                        } else {
                            return `Thank you for trusting me with your thoughts. I can sense there's something meaningful you want to talk about. I'm here to listen without judgment. What would feel most helpful to explore together?`;
                        }
                }
            }
        }

        // Initialize Eden AI
        const eden = new EdenAI();

        function checkUserLimit() {
            if (userCount >= MAX_USERS) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #8eaf78 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center;">
                        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); max-width: 500px;">
                            <h2 style="color: #8eaf78; margin-bottom: 20px;">Beta Access Full</h2>
                            <p style="color: #5a6c57; margin-bottom: 15px; line-height: 1.6;">This beta version of HeartoListen has reached its user limit of ${MAX_USERS} people.</p>
                            <p style="color: #5a6c57; line-height: 1.6;">Thank you for your interest in our mental wellbeing support companion. We're working on expanding access soon.</p>
                        </div>
                    </div>
                `;
                return false;
            }
            userCount++;
            return true;
        }

        function saveMemory(userMessage, aiResponse, emotion = null) {
            const newMemory = {
                id: Date.now(),
                date: new Date().toISOString(),
                userMessage: userMessage,
                aiResponse: aiResponse,
                emotion: emotion,
                timestamp: Date.now()
            };
            
            memories.unshift(newMemory);
            if (memories.length > MAX_MEMORIES) {
                memories = memories.slice(0, MAX_MEMORIES);
            }
        }

        function saveMemory(userMessage, aiResponse, analysis = null) {
            const newMemory = {
                id: Date.now(),
                date: new Date().toISOString(),
                userMessage: userMessage,
                aiResponse: aiResponse,
                emotion: analysis?.emotion || null,
                themes: analysis?.themes || [],
                timestamp: Date.now()
            };
            
            memories.unshift(newMemory);
            
            // Keep only memories from last 30 days
            const thirtyDaysAgo = Date.now() - (MEMORY_EXPIRY_DAYS * 24 * 60 * 60 * 1000);
            memories = memories.filter(memory => memory.timestamp > thirtyDaysAgo);
            
            if (memories.length > MAX_MEMORIES) {
                memories = memories.slice(0, MAX_MEMORIES);
            }

            // Add to current conversation context
            currentConversation.push({
                userMessage,
                aiResponse,
                analysis,
                timestamp: Date.now()
            });

            // Keep conversation context manageable
            if (currentConversation.length > 10) {
                currentConversation = currentConversation.slice(-8);
            }
        }

        function generateAIResponse(userMessage) {
            // Analyze the current message
            const analysis = eden.analyzeMessage(userMessage);
            
            // Handle crisis situations immediately
            if (analysis.urgency === 'high') {
                return eden.generateContextualResponse(userMessage, analysis, currentConversation, memories);
            }

            // Generate contextual response
            const response = eden.generateContextualResponse(userMessage, analysis, currentConversation, memories);
            
            return response;
        }

        function showDisclaimerModal() {
            if (!hasSeenDisclaimer) {
                document.getElementById('disclaimerOverlay').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                displayMemoryRecap();
            }
        }

        function acceptDisclaimer() {
            hasSeenDisclaimer = true;
            document.getElementById('disclaimerOverlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            displayMemoryRecap();
            
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }

        function getNeedHelpNow() {
            window.open('https://988lifeline.org/', '_blank');
            window.open('https://www.samaritans.org/', '_blank');
            window.open('https://www.lifeline.org.au/', '_blank');
        }

        function displayMemoryRecap() {
            if (memories.length > 0) {
                const memoryRecap = document.getElementById('memoryRecap');
                const memoryList = document.getElementById('memoryList');
                
                memoryList.innerHTML = '';
                memories.slice(0, 3).forEach(memory => {
                    const li = document.createElement('li');
                    const date = new Date(memory.date);
                    const relativeTime = getRelativeTime(date);
                    li.textContent = `${relativeTime}: "${memory.userMessage.substring(0, 50)}..."`;
                    memoryList.appendChild(li);
                });
                
                memoryRecap.style.display = 'block';
            }
        }

        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffHours < 1) return 'Earlier today';
            if (diffHours < 24) return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return 'Last week';
        }

        function addMessage(content, isUser = false, isError = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            
            if (isError) {
                messageDiv.className = 'message error-message';
                messageDiv.textContent = content;
            } else if (isUser) {
                messageDiv.className = 'message user-message';
                messageDiv.textContent = content;
            } else {
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = `
                    <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden" class="ai-avatar">
                    <div class="ai-message-content">${content}</div>
                `;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;

            // Compact header after first message
            if (chatArea.children.length > 2) {
                document.getElementById('logoHeader').classList.add('compact');
                document.getElementById('welcomeSection').style.display = 'none';
            }
        }

        function showThinking() {
            const chatArea = document.getElementById('chatArea');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message ai-message';
            thinkingDiv.id = 'thinking-message';
            thinkingDiv.innerHTML = `
                <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden" class="ai-avatar">
                <div class="ai-message-content">
                    <div class="thinking-heart">💚</div>
                </div>
            `;
            
            chatArea.appendChild(thinkingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            return thinkingDiv;
        }

        function hideThinking() {
            const thinkingMessage = document.getElementById('thinking-message');
            if (thinkingMessage) {
                thinkingMessage.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;

            // Disable input and button
            input.disabled = true;
            sendButton.disabled = true;
            
            // Add user message
            addMessage(message, true);
            
            // Clear input
            input.value = '';
            
            // Show thinking animation
            const thinkingElement = showThinking();
            
            try {
                // Simulate realistic thinking time (1-3 seconds)
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                // Analyze message and generate response
                const analysis = eden.analyzeMessage(message);
                const aiResponse = generateAIResponse(message);
                
                // Save to memory with analysis
                saveMemory(message, aiResponse, analysis);
                
                // Hide thinking and show response
                hideThinking();
                addMessage(aiResponse);
                
            } catch (error) {
                hideThinking();
                addMessage('I apologize, but I encountered an issue. Please try again or consider reaching out to a mental health professional if you need immediate support.', false, true);
            } finally {
                // Re-enable input and button
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize app
        window.addEventListener('load', function() {
            if (checkUserLimit()) {
                showDisclaimerModal();
            }
        });

        // Add some sample memories for demonstration
        setTimeout(() => {
            if (memories.length === 0) {
                // Add some sample previous conversations for demo
                memories = [
                    {
                        id: Date.now() - 86400000,
                        date: new Date(Date.now() - 86400000).toISOString(),
                        userMessage: "I've been feeling really anxious about work lately",
                        aiResponse: "It sounds like work has been weighing heavily on your mind...",
                        emotion: "anxious",
                        timestamp: Date.now() - 86400000
                    },
                    {
                        id: Date.now() - 172800000,
                        date: new Date(Date.now() - 172800000).toISOString(),
                        userMessage: "Had a better day today, feeling more hopeful",
                        aiResponse: "I'm so glad to hear you're feeling more hopeful...",
                        emotion: "positive",
                        timestamp: Date.now() - 172800000
                    }
                ];
            }
        }, 1000);
    </script>
</body>
</html>
