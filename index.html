<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HeartoListen - AI Mental Wellbeing Support</title>
<meta name="description" content="Free AI-powered Mental Wellbeing Support Companion. Your 24/7 safe, private and judgement-free space for mental wellness.">
<meta name="theme-color" content="#8eaf78">

<!-- PWA and App Icon Meta Tags -->
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="manifest" href="app-manifest.json">

<!-- iOS specific -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="HeartoListen">

<!-- Android specific -->
<meta name="mobile-web-app-capable" content="yes">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #8eaf78 0%, #764ba2 100%);
min-height: 100vh;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
background-image: url('https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/fern background.png');
}

.container {
width: 100%;
max-width: 800px;
background: rgba(255, 255, 255, 0.95);
border-radius: 20px;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(10px);
overflow: hidden;
display: flex;
flex-direction: column;
height: 700px;
}

.logo-header {
background: linear-gradient(135deg, #5f795a 0%, #4CAF50 100%);
padding: 25px;
text-align: center;
color: white;
border-bottom: 3px solid rgba(255, 255, 255, 0.2);
transition: all 0.3s ease;
}

/* Compact header state */
.logo-header.compact {
padding: 15px;
}

.logo {
width: 150px;
height: 150px;
margin: 0 auto 15px auto;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
position: relative;
}

/* Compact logo state */
.logo-header.compact .logo {
width: 60px;
height: 60px;
margin: 0 auto;
}

.logo:hover {
transform: scale(1.05);
}

.logo-header h1 {
font-size: 2.2em;
margin-bottom: 8px;
font-weight: 700;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.logo-header p {
opacity: 0.95;
font-size: 1.1em;
font-weight: 500;
transition: all 0.3s ease;
}

/* Hide text in compact mode */
.logo-header.compact h1,
.logo-header.compact p {
display: none;
}

.chat-area {
flex: 1;
overflow-y: auto;
padding: 20px;
display: flex;
flex-direction: column;
gap: 15px;
background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
}

.message {
max-width: 85%;
padding: 15px 20px;
border-radius: 18px;
animation: fadeIn 0.3s ease-out;
line-height: 1.6;
font-size: 15px;
white-space: pre-wrap;
}

.ai-message {
background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
color: #274e13;
align-self: flex-start;
border-left: 4px solid #4CAF50;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
display: flex;
align-items: flex-start;
gap: 12px;
padding: 15px 20px;
}

.ai-message-content {
flex: 1;
line-height: 1.6;
}

.ai-avatar {
width: 50px;
height: 50px;
border-radius: 50%;
border: 2px solid rgba(76, 175, 80, 0.3);
object-fit: cover;
object-position: center;
flex-shrink: 0;
}

.user-message {
background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
color: white;
align-self: flex-end;
box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
}

.error-message {
background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
color: #c62828;
align-self: flex-start;
border-left: 4px solid #f44336;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.thinking-heart {
font-size: 24px;
animation: heartPulse 1.5s ease-in-out infinite;
display: flex;
justify-content: center;
align-items: center;
}

.welcome-section {
text-align: center;
margin: 20px 0;
padding: 25px;
background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(139, 195, 74, 0.08) 100%);
border-radius: 15px;
border: 2px dashed rgba(76, 175, 80, 0.2);
}

.welcome-section h2 {
color: #8eaf78;
font-size: 1.4em;
margin-bottom: 10px;
font-weight: 600;
}

.welcome-section p {
color: #5a6c57;
line-height: 1.6;
margin-bottom: 15px;
}

.disclaimer {
background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
border: 2px solid #f39c12;
border-radius: 12px;
padding: 15px;
margin: 15px 0;
font-size: 13px;
color: #8b4513;
text-align: center;
font-weight: 500;
}

.input-area {
padding: 20px;
background: rgba(255, 255, 255, 0.95);
border-top: 1px solid rgba(0, 0, 0, 0.1);
display: flex;
gap: 15px;
align-items: center;
}

.input-field {
flex: 1;
padding: 15px 20px;
border: 2px solid #e0e0e0;
border-radius: 25px;
font-size: 14px;
outline: none;
transition: all 0.3s ease;
background: white;
font-family: inherit;
}

.input-field:focus {
border-color: #4CAF50;
box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.send-button {
padding: 15px 25px;
background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
color: white;
border: none;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 80px;
}

.send-button:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
}

.send-button:active {
transform: translateY(0);
}

.send-button:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

.ai-status {
background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
border: 2px solid rgba(76, 175, 80, 0.3);
border-radius: 12px;
padding: 10px 15px;
margin: 10px 0;
font-size: 12px;
color: #2e7d32;
text-align: center;
font-style: italic;
transition: all 0.3s ease;
}

.pwa-status {
background: linear-gradient(135deg, #f3e5f5 0%, #e8f5e8 100%);
border: 2px solid rgba(156, 39, 176, 0.3);
border-radius: 12px;
padding: 8px 12px;
margin: 5px 0;
font-size: 11px;
color: #6a1b9a;
text-align: center;
font-style: italic;
display: none;
}

.pwa-status.show {
display: block;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

@keyframes heartPulse {
0%, 100% {
transform: scale(1);
opacity: 0.8;
}
50% {
transform: scale(1.3);
opacity: 1;
}
}

/* Responsive design */
@media (max-width: 600px) {
.container {
height: 90vh;
margin: 10px;
}

.logo {
width: 120px;
height: 120px;
}

.logo-header.compact .logo {
width: 50px;
height: 50px;
}

.logo-header h1 {
font-size: 1.8em;
}

.message {
max-width: 95%;
}
}

/* DISCLAIMER MODAL STYLES */
.disclaimer-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
z-index: 3000;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
backdrop-filter: blur(5px);
}

.disclaimer-modal {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 600px;
width: 100%;
max-height: 80vh;
overflow-y: auto;
text-align: left;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
animation: disclaimerSlideIn 0.4s ease-out;
border: 3px solid #8eaf78;
}

.disclaimer-modal h2 {
color: #8eaf78;
text-align: center;
margin-bottom: 25px;
font-size: 1.8em;
font-weight: 700;
}

.disclaimer-modal .warning-icon {
text-align: center;
font-size: 3em;
margin-bottom: 15px;
}

.disclaimer-content {
color: #333;
line-height: 1.6;
font-size: 14px;
}

.disclaimer-content p {
margin-bottom: 15px;
}

.disclaimer-content strong {
color: #2c5530;
font-weight: 600;
}

.emergency-section {
background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
border: 2px solid #e91e63;
border-radius: 12px;
padding: 20px;
margin: 20px 0;
}

.emergency-section h3 {
color: #c2185b;
margin-bottom: 15px;
font-size: 1.2em;
display: flex;
align-items: center;
gap: 10px;
}

.emergency-contacts {
margin: 15px 0;
padding-left: 20px;
}

.emergency-contacts li {
margin-bottom: 8px;
color: #880e4f;
font-weight: 500;
}

.important-notes {
background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
border: 2px solid #f39c12;
border-radius: 12px;
padding: 20px;
margin: 20px 0;
}

.important-notes h3 {
color: #e67e22;
margin-bottom: 15px;
font-size: 1.2em;
display: flex;
align-items: center;
gap: 10px;
}

.important-notes ul {
padding-left: 20px;
}

.important-notes li {
margin-bottom: 8px;
color: #8b4513;
}

.disclaimer-buttons {
display: flex;
gap: 15px;
justify-content: center;
margin-top: 30px;
flex-wrap: wrap;
}

.btn-accept {
background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 180px;
}

.btn-accept:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(142, 175, 120, 0.3);
}

.btn-help {
background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 180px;
}

.btn-help:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(233, 30, 99, 0.3);
}

@keyframes disclaimerSlideIn {
from {
opacity: 0;
transform: translateY(-50px) scale(0.9);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

/* Mobile responsiveness */
@media (max-width: 600px) {
.disclaimer-modal {
padding: 20px;
margin: 10px;
max-height: 90vh;
}

.disclaimer-modal h2 {
font-size: 1.5em;
}

.disclaimer-content {
font-size: 13px;
}

.disclaimer-buttons {
flex-direction: column;
align-items: center;
}

.btn-accept,
.btn-help {
width: 100%;
max-width: 250px;
}
}

.disclaimer-hidden {
display: none !important;
}

.disclaimer-visible {
display: flex !important;
}
</style>
</head>
<body>
<!-- DISCLAIMER MODAL -->
<div id="disclaimerOverlay" class="disclaimer-overlay disclaimer-visible">
<div class="disclaimer-modal">
<div class="warning-icon">⚠️</div>
<h2>Important Disclaimer</h2>

<div class="disclaimer-content">
<p><strong>This app is designed to provide emotional support, encouragement, and validation. It is not a substitute for professional medical, psychiatric, or psychological treatment.</strong></p>

<p>The content and features within this app are for general well-being, personal growth, and self-reflection purposes only. We are not medical professionals, and this app does not offer medical, clinical, or therapeutic advice.</p>

<p>If you are experiencing significant distress, a mental health crisis, or believe you may have a condition requiring diagnosis or treatment, please seek help from a qualified healthcare provider.</p>

<div class="important-notes">
<h3>📋 Important Notes</h3>
<ul>
<li>The app does not provide diagnosis, treatment, prescriptions, or medical interventions.</li>
<li>Use of this app is voluntary and should be considered a complementary tool to professional care, not a replacement.</li>
<li>Any decisions you make based on the information, tools, or suggestions provided are your personal responsibility.</li>
</ul>
</div>

<p><strong>By using this app, you acknowledge and agree that it is intended to provide support, validation, and helpful resources, but it cannot and does not replace the care of licensed professionals.</strong></p>
</div>

<div class="disclaimer-buttons">
<button class="btn-accept" onclick="acceptDisclaimer()">I Understand & Agree</button>
<button class="btn-help" onclick="getNeedHelpNow()">I Need Help Now</button>
</div>

<div class="emergency-section">
<h3>🚨 Emergency Situations</h3>
<p><strong>If you are in immediate danger or experiencing thoughts of harming yourself or others, please call your local emergency number right away.</strong></p>

<ul class="emergency-contacts">
<li><strong>In the U.S.:</strong> you can dial 988 for the Suicide & Crisis Lifeline</li>
<li><strong>In the U.K. & Ireland:</strong> you can call Samaritans at 116 123</li>
<li><strong>In Australia:</strong> you can call Lifeline at 13 11 14</li>
</ul>

<p>If you are outside these regions, please look up local emergency and crisis services in your area.</p>
</div>
</div>
</div>

<div class="container">
<!-- Logo Header Section -->
<div class="logo-header" id="logoHeader">
<div class="logo">
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png" alt="HeartoListen Logo" style="width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 10;">
</div> 
<h1>HeartoListen</h1>
<p>AI Mental Wellbeing Support - Self Discovery for Positive Mental Health</p>
</div>

<!-- Chat Area -->
<div class="chat-area" id="chatArea">
<!-- Welcome Message -->
<div class="welcome-section" id="welcomeSection">
<h2>Welcome to Hear to Listen</h2>
<div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(76, 175, 80, 0.3); object-fit: cover; object-position: center;">
<p style="margin: 0;">I'm Eden and I am here to listen and support you through whatever you're experiencing. This is a safe, judgement-free space where you can share your thoughts and feelings.</p>
</div>

<!-- AI Status Indicator -->
<div class="ai-status" id="aiStatus">
🤖 Powered by Claude AI - Ready to support you
</div>

<!-- PWA Status Indicator -->
<div class="pwa-status" id="pwaStatus">
📱 App ready for offline use
</div>

<!-- Important Disclaimer -->
<div class="disclaimer">
<strong>⚠️ Important Safety Information:</strong>
<br><br>
<strong>Crisis Support:</strong> If you're having thoughts of suicide or self-harm, please reach out immediately:
<br>• <strong>UK:</strong> 999 (Emergency) | 116 123 (Samaritans - 24/7 free)
<br>• <strong>USA:</strong> 911 (Emergency) | 988 (Suicide & Crisis Lifeline)
<br>• <strong>Crisis Text:</strong> Text HOME to 741741
<br><br>
<strong>This app provides peer support and guidance, not professional medical advice.</strong> For ongoing mental health concerns, please seek professional Mental Wellbeing Support
</div>
</div>
</div>

<!-- Input Area -->
<div class="input-area">
<input type="text" 
id="messageInput" 
class="input-field" 
placeholder="What's on your mind......" 
onkeypress="handleKeyPress(event)">
<button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
</div>
</div>

<script>
// Global variables
let conversationHistory = [];
let isFirstMessage = true;
let disclaimerAccepted = false;
let isUsingAI = true;
let serviceWorkerRegistered = false;

// Initialize app when page loads
document.addEventListener('DOMContentLoaded', function() {
    showDisclaimer();
    
    // Disable main app until disclaimer is accepted
    document.getElementById('messageInput').disabled = true;
    document.getElementById('sendButton').disabled = true;
});

function showDisclaimer() {
    const overlay = document.getElementById('disclaimerOverlay');
    overlay.className = 'disclaimer-overlay disclaimer-visible';
    console.log('Disclaimer shown');
}

function acceptDisclaimer() {
    const overlay = document.getElementById('disclaimerOverlay');
    overlay.className = 'disclaimer-overlay disclaimer-hidden';
    
    // Enable the app
    disclaimerAccepted = true;
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendButton').disabled = false;
    document.getElementById('messageInput').focus();
    
    console.log('Disclaimer accepted');
}

function getNeedHelpNow() {
    // Show crisis resources immediately
    const crisisMessage = `IMMEDIATE HELP AVAILABLE:\n\n` +
        `🚨 EMERGENCY: Call your local emergency number\n\n` +
        `CRISIS SUPPORT:\n` +
        `• UK & Ireland: 116 123 (Samaritans - free, 24/7)\n` +
        `• USA: 988 (Suicide & Crisis Lifeline)\n` +
        `• Australia: 13 11 14 (Lifeline)\n` +
        `• Crisis Text Line: Text "HOME" to 741741\n\n` +
        `You are not alone. Help is available right now.`;
    
    alert(crisisMessage);
    
    // Open Samaritans website
    window.open('https://www.samaritans.org/', '_blank');
}

// Handle key press
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Main send message function
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const message = messageInput.value.trim();

    if (!message) return;

    // Check for emergency keywords first
    checkForEmergencyKeywords(message);

    // Hide welcome section after first message
    if (isFirstMessage) {
        document.getElementById('welcomeSection').style.display = 'none';
        document.getElementById('logoHeader').classList.add('compact');
        isFirstMessage = false;
    }

    // Disable input
    messageInput.value = '';
    sendButton.disabled = true;
    sendButton.textContent = 'Sending...';

    // Add user message
    addMessage(message, 'user');

    // Show typing indicator
    const typingIndicator = addTypingIndicator();

    try {
        // Generate AI response
        const response = await generateAIResponse(message);

        // Remove typing indicator
        typingIndicator.remove();

        // Add AI response
        addMessage(response, 'ai');

        // Save to conversation history
        conversationHistory.push({ user: message, ai: response });

        // Update conversation context
        updateConversationContext();

        // Update AI status
        updateAIStatus('✅ Response generated successfully');

    } catch (error) {
        console.error('Error getting response:', error);
        typingIndicator.remove();
        
        // Try fallback response
        try {
            const fallbackResponse = await generateFallbackResponse(message);
            addMessage(fallbackResponse, 'ai');
            conversationHistory.push({ user: message, ai: fallbackResponse });
            updateAIStatus('⚠️ Using fallback responses - Claude AI temporarily unavailable');
        } catch (fallbackError) {
            addMessage('I apologize, but I\'m having trouble responding right now. Please try again in a moment. Remember, if you\'re in crisis, please contact emergency services immediately.', 'error');
            updateAIStatus('❌ Connection issues - Please try again');
        }
    }

    // Re-enable input
    sendButton.disabled = false;
    sendButton.textContent = 'Send';
    messageInput.focus();
}

// Generate AI response using Claude API
async function generateAIResponse(userMessage) {
    try {
        updateAIStatus('🤖 Claude AI is thinking...');
        
        const response = await fetch('/.netlify/functions/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: userMessage,
                conversationHistory: conversationHistory
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Unknown error occurred');
        }

        return data.response;

    } catch (error) {
        console.error('Error with Claude API:', error);
        updateAIStatus('⚠️ Claude AI unavailable, switching to backup...');
        throw error;
    }
}

// Fallback response system (your original logic)
async function generateFallbackResponse(userMessage) {
    // Simulate processing delay
    await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));

    // Detect mental health conditions and emotional tone
    const conditions = detectMentalHealthConditions(userMessage);
    const emotionalTone = analyzeEmotionalTone(userMessage);
    const context = analyzeContext(userMessage, conversationHistory);

    // Generate contextual response
    const response = selectResponse(conditions, emotionalTone, context);

    return response;
}

// Mental health condition detection
function detectMentalHealthConditions(message) {
    const lowerMessage = message.toLowerCase();
    const conditions = [];

    // Depression indicators
    if (lowerMessage.match(/\b(depressed|depression|hopeless|worthless|empty|numb|sad|down|low|can't feel|lost interest|nothing matters|pointless|exhausted|tired all the time)\b/)) {
        conditions.push('depression');
    }

    // Anxiety indicators
    if (lowerMessage.match(/\b(anxious|anxiety|panic|worried|nervous|scared|afraid|fear|racing heart|can't breathe|overwhelming|catastrophic thinking|what if)\b/)) {
        conditions.push('anxiety');
    }

    // Stress indicators
    if (lowerMessage.match(/\b(stressed|overwhelmed|too much|can't cope|burned out|pressure|deadline)\b/)) {
        conditions.push('stress');
    }

    // Loneliness indicators
    if (lowerMessage.match(/\b(lonely|alone|isolated|disconnected|no friends|nobody understands)\b/)) {
        conditions.push('loneliness');
    }

    // Relationship issues
    if (lowerMessage.match(/\b(relationship|breakup|partner|boyfriend|girlfriend|marriage|divorce|family problems)\b/)) {
        conditions.push('relationships');
    }

    // Work/career issues
    if (lowerMessage.match(/\b(work|job|career|boss|colleague|workplace|unemployed|fired|quit)\b/)) {
        conditions.push('work');
    }

    return conditions.length > 0 ? conditions : ['general'];
}

// Emotional tone analysis
function analyzeEmotionalTone(message) {
    const lowerMessage = message.toLowerCase();

    if (lowerMessage.match(/\b(angry|mad|furious|rage|pissed|frustrated)\b/)) return 'angry';
    if (lowerMessage.match(/\b(sad|crying|tears|heartbroken|devastated)\b/)) return 'sad';
    if (lowerMessage.match(/\b(scared|terrified|frightened|afraid|fearful)\b/)) return 'fearful';
    if (lowerMessage.match(/\b(excited|happy|joy|great|amazing|wonderful)\b/)) return 'positive';
    if (lowerMessage.match(/\b(confused|lost|don't know|uncertain|mixed up)\b/)) return 'confused';

    return 'neutral';
}

// Context analysis
function analyzeContext(message, history) {
    return {
        isFirstMessage: history.length === 0,
        previousTopics: history.slice(-3).map(h => h.user).join(' '),
        messageLength: message.length,
        timeOfDay: new Date().getHours()
    };
}

// Response selection system for fallback
function selectResponse(conditions, tone, context) {
    const primaryCondition = conditions[0] || 'general';
    const responses = getResponseBank();

    // Get appropriate response bank
    const conditionResponses = responses[primaryCondition] || responses['general'];
    const responseOptions = context.isFirstMessage ? 
        conditionResponses.first_time || conditionResponses : 
        conditionResponses.returning || conditionResponses;

    // Select response
    let selectedResponse;
    if (Array.isArray(responseOptions)) {
        selectedResponse = responseOptions[Math.floor(Math.random() * responseOptions.length)];
    } else {
        selectedResponse = responseOptions;
    }

    return selectedResponse;
}

// Fallback response bank
function getResponseBank() {
    return {
        depression: [
            "I hear how heavy things feel right now. Depression can make everything seem overwhelming and exhausting. You're not alone in feeling this way, and it takes courage to reach out. What's been the hardest part of your day today?",

            "That sounds incredibly difficult to carry. When we're dealing with depression, even small tasks can feel monumental. Have you been able to take care of yourself today - maybe had something to eat or gotten a bit of rest?",

            "I can sense the weight you're feeling. Depression has a way of making us feel disconnected from the things that usually bring us joy. Is there anything, even something very small, that has brought you a moment of comfort recently?"
        ],

        anxiety: [
            "Anxiety can feel so overwhelming - like your mind is racing and you can't catch your breath. What you're experiencing is real and valid. Are you somewhere safe right now where you can try some slow, deep breathing?",

            "Those anxious thoughts can spiral so quickly. It sounds like your mind is working overtime trying to protect you, but it's exhausting. Have you tried any grounding techniques, like naming 5 things you can see around you?",

            "I understand that anxious feeling - it's like your body is preparing for danger even when you're safe. Sometimes anxiety tries to solve problems by worrying, but it ends up creating more distress. What's worrying you most right now?"
        ],

        stress: [
            "It sounds like you're carrying a lot right now. Stress can build up until everything feels urgent and overwhelming. What's the biggest source of pressure you're dealing with today?",

            "That level of stress must be exhausting. When everything feels like too much, sometimes we need to step back and prioritize. What's one thing you could let go of or ask for help with?",

            "I hear how overwhelmed you're feeling. Stress has a way of making everything seem equally urgent. Have you been able to take any breaks today, even just for a few minutes?"
        ],

        loneliness: [
            "Loneliness can feel so profound, like you're the only person in the world feeling this way. But you're not alone in experiencing loneliness - it's one of the most human experiences we share. What's making you feel most isolated right now?",

            "That sense of disconnection is so painful. Even when we're surrounded by people, we can still feel deeply alone. Is there someone in your life you feel comfortable reaching out to, even just to say hello?",

            "I'm here with you right now, and I want you to know that your feelings matter. Loneliness doesn't mean there's something wrong with you - it often means you're someone who values connection. What kind of connection are you most missing?"
        ],

        relationships: [
            "Relationship challenges can affect every part of our lives. It sounds like you're going through something really difficult. Do you want to share what's happening?",

            "People we care about have such power to hurt us, but also to heal us. It sounds like you're in pain right now. What's the most challenging part of what you're dealing with?",

            "Relationships can be so complex - full of love and frustration at the same time. What you're going through sounds really hard. How are you taking care of yourself through this?"
        ],

        work: [
            "Work stress can really take over our lives, especially when we're feeling overwhelmed or unsupported. What's been the most challenging aspect of your work situation?",

            "Career challenges can affect so much more than just our professional lives - they impact our sense of worth and security. What's going on at work that's weighing on you?",

            "Job situations can feel all-consuming when they're not going well. It sounds like work is really affecting you right now. Are you able to find any separation between work stress and your personal time?"
        ],

        general: [
            "I'm here to listen to whatever is on your mind. Sometimes it helps just to have someone hear what you're going through. What would you like to share?",

            "Thank you for reaching out. It takes courage to open up about what we're experiencing. I'm here to support you through whatever you're dealing with. What's been on your heart lately?",

            "I'm glad you're here and that you felt comfortable sharing with me. Everyone deserves to have their feelings heard and validated. What's the most important thing you want me to understand about how you're feeling?",

            "Life can bring so many different challenges and experiences. I want you to know this is a safe space for you to express whatever you're going through. What's been weighing on you recently?"
        ]
    };
}

// Add message to chat
function addMessage(content, type) {
    const chatArea = document.getElementById('chatArea');
    const messageDiv = document.createElement('div');

    if (type === 'user') {
        messageDiv.className = 'message user-message';
        messageDiv.textContent = content;
    } else if (type === 'ai') {
        messageDiv.className = 'message ai-message';
        messageDiv.innerHTML = `
            <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
            <div class="ai-message-content">${content}</div>
        `;
    } else if (type === 'error') {
        messageDiv.className = 'message error-message';
        messageDiv.textContent = content;
    }

    chatArea.appendChild(messageDiv);
    smoothScrollToBottom();
    return messageDiv;
}

// Add typing indicator
function addTypingIndicator() {
    const chatArea = document.getElementById('chatArea');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message';
    typingDiv.innerHTML = `
        <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
        <div class="ai-message-content">
            <div class="thinking-heart">💚</div>
        </div>
    `;

    chatArea.appendChild(typingDiv);
    smoothScrollToBottom();
    return typingDiv;
}

// Update AI status indicator
function updateAIStatus(status) {
    const statusElement = document.getElementById('aiStatus');
    if (statusElement) {
        statusElement.textContent = status;
        // Auto-hide status after 5 seconds unless it's an error
        if (!status.includes('❌') && !status.includes('⚠️')) {
            setTimeout(() => {
                statusElement.textContent = '🤖 Powered by Claude AI - Ready to support you';
            }, 5000);
        }
    }
}

// Update PWA status indicator
function updatePWAStatus(status, show = true) {
    const statusElement = document.getElementById('pwaStatus');
    if (statusElement) {
        statusElement.textContent = status;
        if (show) {
            statusElement.className = 'pwa-status show';
        } else {
            statusElement.className = 'pwa-status';
        }
    }
}

// Emergency detection in messages
function checkForEmergencyKeywords(message) {
    const emergencyKeywords = [
        'suicide', 'kill myself', 'end my life', 'want to die', 'hurt myself', 
        'self harm', 'cutting', 'overdose', 'jump off', 'hang myself'
    ];
    
    const lowerMessage = message.toLowerCase();
    const hasEmergencyKeywords = emergencyKeywords.some(keyword => 
        lowerMessage.includes(keyword)
    );
    
    if (hasEmergencyKeywords) {
        // Show emergency resources immediately after AI response
        setTimeout(() => {
            addMessage(`🚨 I'm very concerned about what you've shared. Please know that help is available right now:

• **Emergency Services**: Call 999 (UK), 911 (US), or your local emergency number
• **UK Crisis Support**: Samaritans at 116 123 (free, 24/7)
• **US Crisis Support**: 988 (Suicide & Crisis Lifeline)
• **Crisis Text Line**: Text "HOME" to 741741

You don't have to go through this alone. Professional help is available, and there are people who care about you and want to help you through this difficult time.`, 'ai');
        }, 2000);
    }
}

// Conversation context tracking
function updateConversationContext() {
    if (conversationHistory.length > 10) {
        // Keep only the last 10 exchanges to manage memory
        conversationHistory = conversationHistory.slice(-10);
    }
}

// Auto-scroll to bottom when new messages arrive
function smoothScrollToBottom() {
    const chatArea = document.getElementById('chatArea');
    chatArea.scrollTo({
        top: chatArea.scrollHeight,
        behavior: 'smooth'
    });
}

// Enhanced Service Worker registration for PWA functionality
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful');
                serviceWorkerRegistered = true;
                updatePWAStatus('📱 App installed - Works offline!', true);
                
                // Hide PWA status after 3 seconds
                setTimeout(() => {
                    updatePWAStatus('', false);
                }, 3000);
                
                // Check for updates
                registration.addEventListener('updatefound', function() {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', function() {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            updatePWAStatus('🔄 New version available - Refresh to update', true);
                        }
                    });
                });
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
                updatePWAStatus('⚠️ Offline mode unavailable', true);
                setTimeout(() => {
                    updatePWAStatus('', false);
                }, 3000);
            });
    });
}

// Handle online/offline status
window.addEventListener('online', function() {
    updateAIStatus('🟢 Back online - Claude AI available');
    isUsingAI = true;
    if (serviceWorkerRegistered) {
        updatePWAStatus('🌐 Connected - Full features available', true);
        setTimeout(() => {
            updatePWAStatus('', false);
        }, 3000);
    }
});

window.addEventListener('offline', function() {
    updateAIStatus('🔴 Offline - Using local responses only');
    isUsingAI = false;
    if (serviceWorkerRegistered) {
        updatePWAStatus('📱 Offline mode - Basic support available', true);
    } else {
        updatePWAStatus('❌ No offline support - Install app for offline use', true);
    }
});

// Initialize online status
if (!navigator.onLine) {
    updateAIStatus('🔴 Offline - Using local responses only');
    isUsingAI = false;
    if (serviceWorkerRegistered) {
        updatePWAStatus('📱 Offline mode active', true);
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    // Ctrl/Cmd + Enter to send message
    if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        sendMessage();
    }
    
    // Escape to clear input
    if (event.key === 'Escape') {
        document.getElementById('messageInput').value = '';
    }
});

// Focus management
document.getElementById('messageInput').addEventListener('blur', function() {
    // Re-focus after a short delay to keep input accessible
    setTimeout(() => {
        if (disclaimerAccepted && !document.getElementById('sendButton').disabled) {
            this.focus();
        }
    }, 100);
});

// Prevent form submission on enter (handled by handleKeyPress)
document.getElementById('messageInput').addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
    }
});

// Error handling for network issues
window.addEventListener('error', function(event) {
    console.error('Global error:', event.error);
    updateAIStatus('⚠️ Unexpected error occurred');
});

// Unhandled promise rejection handling
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    updateAIStatus('⚠️ Network or processing error');
});

// PWA Install prompt handling
let deferredPrompt;

window.addEventListener('beforeinstallprompt', function(event) {
    // Prevent Chrome 67 and earlier from automatically showing the prompt
    event.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = event;
    
    // Show custom install banner
    updatePWAStatus('📱 Install app for better experience - Tap here!', true);
    
    // Make PWA status clickable for install
    const pwaStatus = document.getElementById('pwaStatus');
    if (pwaStatus) {
        pwaStatus.style.cursor = 'pointer';
        pwaStatus.onclick = function() {
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then(function(choiceResult) {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    updatePWAStatus('✅ App installed successfully!', true);
                } else {
                    console.log('User dismissed the install prompt');
                    updatePWAStatus('', false);
                }
                deferredPrompt = null;
                pwaStatus.onclick = null;
                pwaStatus.style.cursor = 'default';
            });
        };
    }
});

// Handle successful app install
window.addEventListener('appinstalled', function(event) {
    console.log('HeartoListen app installed successfully');
    updatePWAStatus('✅ App installed - Now available offline!', true);
    setTimeout(() => {
        updatePWAStatus('', false);
    }, 5000);
});

console.log('HeartoListen app initialized with Claude AI integration and full PWA support');
</script>

</body>
</html>
